<!DOCTYPE html>
<html>
<head>
<title>rapport.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/*

Darcula color scheme from the JetBrains family of IDEs

*/


.hljs {
  display: block;
  overflow-x: auto;
  padding: 0.5em;
  background: #2b2b2b;
  color: #bababa;
}

.hljs-strong,
.hljs-emphasis {
  color: #a8a8a2;
}

.hljs-bullet,
.hljs-quote,
.hljs-link,
.hljs-number,
.hljs-regexp,
.hljs-literal {
  color: #6896ba;
}

.hljs-code,
.hljs-selector-class {
  color: #a6e22e;
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-keyword,
.hljs-selector-tag,
.hljs-section,
.hljs-attribute,
.hljs-name,
.hljs-variable {
  color: #cb7832;
}

.hljs-params {
  color: #b9b9b9;
}

.hljs-string {
  color: #6a8759;
}

.hljs-subst,
.hljs-type,
.hljs-built_in,
.hljs-builtin-name,
.hljs-symbol,
.hljs-selector-id,
.hljs-selector-attr,
.hljs-selector-pseudo,
.hljs-template-tag,
.hljs-template-variable,
.hljs-addition {
  color: #e0c46c;
}

.hljs-comment,
.hljs-deletion,
.hljs-meta {
  color: #7f7f7f;
}

</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	font-size: 12px;
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 3px;
	line-height: 15px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 12px;
	line-height: 15px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="1-rapport-de-projet--banc-de-mesures-de-la-consommation-%C3%A9lectrique-pour-application-web">1. Rapport de projet : Banc de mesures de la consommation électrique pour application web</h1>
<img src="../capture/CuruisTRex.png" alt="Image" width="100%" style="width:100%;">
<p><br><br><br><br><br></p>
<hr>
<p><strong>Candidat:</strong> Cyril Tobler<br>
<strong>Proposé par:</strong> SINABE Sarl<br>
<strong>Personne de contact:</strong> Benoit Vianin<br>
<strong>Enseignant-e:</strong> Fabien Maire<br>
<strong>Lieu de travail:</strong> Ecole CPNE-TI SIS2<br>
<strong>Nombre de périodes:</strong> 300<br>
<strong>Durée du travail :</strong>  <em>14.08.23 - 22.09.23</em></p>
<hr>
<div style="page-break-after: always;"></div>
<h1 id="2-sommaire">2. Sommaire</h1>
<ul>
<li><a href="#1-rapport-de-projet--banc-de-mesures-de-la-consommation-%C3%A9lectrique-pour-application-web">1. Rapport de projet : Banc de mesures de la consommation électrique pour application web</a></li>
<li><a href="#2-sommaire">2. Sommaire</a></li>
<li><a href="#3-introduction">3. Introduction</a></li>
<li><a href="#4-planification">4. Planification</a></li>
<li><a href="#5-instalation-physique">5. Instalation physique</a>
<ul>
<li><a href="#51-nidus">5.1. Nidus</a></li>
<li><a href="#52-volt">5.2. Volt</a></li>
</ul>
</li>
<li><a href="#6-sh%C3%A9ma-de-principe">6. Shéma de principe</a></li>
<li><a href="#7-syst%C3%A8mes-dexploitation-os">7. Systèmes d'exploitation (OS)</a>
<ul>
<li><a href="#71-ubuntu">7.1. Ubuntu</a></li>
<li><a href="#72-raspbian">7.2. Raspbian</a></li>
<li><a href="#73-premi%C3%A8re-installation">7.3. Première installation</a></li>
<li><a href="#74-seconde-instalation-ubuntu-server">7.4. Seconde instalation Ubuntu Server</a>
<ul>
<li><a href="#741-configuration-post-instalation">7.4.1. Configuration post instalation</a></li>
<li><a href="#742-instalation-apache">7.4.2. Instalation Apache</a></li>
<li><a href="#743-script-mqtt">7.4.3. Script MQTT</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#8-node-red">8. Node-RED</a>
<ul>
<li><a href="#81-instalation">8.1. Instalation</a></li>
<li><a href="#82-configuration">8.2. Configuration</a>
<ul>
<li><a href="#821-installation-des-plugins">8.2.1. Installation des plugins</a></li>
<li><a href="#822-s%C3%A9curisation-de-node-red">8.2.2. Sécurisation de Node-Red</a></li>
<li><a href="#823-suivi-git">8.2.3. Suivi Git</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#9-gatling">9. Gatling</a>
<ul>
<li><a href="#91-installation">9.1. Installation</a>
<ul>
<li><a href="#911-prerequis">9.1.1. Prerequis</a></li>
<li><a href="#912-download">9.1.2. Download</a></li>
</ul>
</li>
<li><a href="#92-v%C3%A9rification-de-linstallation">9.2. Vérification de l'installation</a></li>
<li><a href="#93-scripts">9.3. Scripts</a></li>
</ul>
</li>
<li><a href="#10-apache-et-site-web">10. Apache et Site Web</a>
<ul>
<li><a href="#101-installation">10.1. Installation</a></li>
<li><a href="#102-mise-en-place-dun-site-web">10.2. Mise en place d'un site Web</a></li>
</ul>
</li>
<li><a href="#11-mqtt">11. MQTT</a>
<ul>
<li><a href="#111-installation-de-mosquitto-sur-nidus">11.1. Installation de Mosquitto sur Nidus</a></li>
<li><a href="#112-ouverture-des-port-sur-nidus">11.2. Ouverture des port sur Nidus</a></li>
<li><a href="#113-script-mqtt">11.3. Script MQTT</a>
<ul>
<li><a href="#1131-script">11.3.1. Script</a></li>
<li><a href="#1132-description-d%C3%A9taill%C3%A9e-du-script">11.3.2. Description détaillée du script</a></li>
<li><a href="#1133-conclusion">11.3.3. Conclusion</a></li>
</ul>
</li>
<li><a href="#114-installation">11.4. Installation</a></li>
<li><a href="#115-utilisation-du-script">11.5. Utilisation du script</a>
<ul>
<li><a href="#1151-v%C3%A9rification">11.5.1. Vérification</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#12-ina219">12. INA219</a>
<ul>
<li><a href="#1201-installation-physique">12.0.1. Installation physique</a>
<ul>
<li><a href="#12011-branchement-sans-volt">12.0.1.1. Branchement SANS VOLT</a></li>
<li><a href="#12012-branchement-avec-volt">12.0.1.2. Branchement AVEC VOLT</a></li>
</ul>
</li>
<li><a href="#1202-v%C3%A9rification-de-la-pr%C3%A9sence-du-ina219">12.0.2. Vérification de la présence du INA219</a></li>
<li><a href="#121-obtention-des-donn%C3%A9es">12.1. Obtention des données</a>
<ul>
<li><a href="#1211-test-avec-le-script-python-a-vide">12.1.1. Test avec le script python A vide</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#13-noeud-node-red">13. Noeud Node-Red</a>
<ul>
<li><a href="#131-ina219">13.1. INA219</a></li>
<li><a href="#132-monitoring">13.2. Monitoring</a></li>
<li><a href="#133-dashboard">13.3. Dashboard</a></li>
<li><a href="#134-pdf">13.4. PDF</a>
<ul>
<li><a href="#1341-base">13.4.1. Base</a></li>
</ul>
</li>
<li><a href="#135-images-de-graphiques-et-de-tableaux">13.5. Images de graphiques et de tableaux</a></li>
</ul>
</li>
<li><a href="#14-stress-test-v10">14. Stress Test V1.0</a>
<ul>
<li><a href="#141-%C3%A9cran-daccueil">14.1. Écran d'Accueil</a></li>
<li><a href="#142-en-ex%C3%A9cution">14.2. En Exécution</a></li>
<li><a href="#143-r%C3%A9sultat">14.3. Résultat</a></li>
<li><a href="#144-purge">14.4. Purge</a></li>
</ul>
</li>
<li><a href="#15-gatling-test-v20">15. Gatling Test V2.0</a>
<ul>
<li><a href="#151-but">15.1. But</a></li>
<li><a href="#152-%C3%A9tapes-%C3%A0-atteindre">15.2. Étapes à Atteindre</a></li>
<li><a href="#153-ex%C3%A9cution-dun-test-pr%C3%A9%C3%A9tabli-sur-gatling-depuis-node-red">15.3. Exécution d'un Test Préétabli sur Gatling depuis Node-Red</a></li>
<li><a href="#154-envoi-de-commande-avec-une-dur%C3%A9e">15.4. Envoi de Commande avec une Durée</a></li>
<li><a href="#155-r%C3%A9cup%C3%A9ration-des-informations">15.5. Récupération des Informations</a></li>
<li><a href="#156-traitement-des-donn%C3%A9es">15.6. Traitement des données</a>
<ul>
<li><a href="#1561-cr%C3%A9ation-des-graphiques">15.6.1. Création des graphiques</a></li>
<li><a href="#1562-pdf">15.6.2. PDF</a></li>
</ul>
</li>
<li><a href="#157-refactoring">15.7. Refactoring</a></li>
</ul>
</li>
<li><a href="#gatling-v30">Gatling V3.0</a>
<ul>
<li><a href="#ui">UI</a>
<ul>
<li><a href="#ventilateur">Ventilateur</a></li>
<li><a href="#ui-1">UI</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#16-remerciement">16. Remerciement</a></li>
<li><a href="#17-sources">17. Sources</a></li>
</ul>
<div style="page-break-after: always;"></div>
<h1 id="3-introduction">3. Introduction</h1>
<p>Le système sera conçu pour simuler des requêtes HTTP réalistes à l'aide de Gatling, mesurer la consommation électrique en utilisant l'INA219 connecté via le bus I2C, et collecter les mesures de performance à l'aide de Node-RED. Les rapports générés fourniront des informations détaillées sur les performances du système testé, y compris le temps de réponse, la consommation d'énergie par requête, l'utilisation du processeur, etc.</p>
<h1 id="4-planification">4. Planification</h1>
<pre><code class="language-mermaid"><div class="mermaid">gantt
    dateFormat  YYYY-MM-DD HH:mm
    title       Planning du Projet
    excludes    weekends,
    axisFormat %Y-%m-%a %H:%M
    tickInterval 4hour
    section Mise en place

    Création du repository pour le projet : done, mise-en-place-a, 2023-08-16 08:00, 2023-08-16 08:40
    Mise en place d'un répertoire de documentation : done, mise-en-place-b, 2023-08-16 08:45, 2023-08-16 10:15
    Installation physique des Raspberry Pi : done, mise-en-place-c, 2023-08-16 10:30, 2023-08-16 14:30
    Configuration des Raspberry Pi : done, mise-en-place-d, 2023-08-16 14:45, 2023-08-16 17:00
    Branchement réseau : done, mise-en-place-e, 2023-08-17 08:00, 2023-08-17 08:50
    Installation de Node-Red : done, mise-en-place-f, 2023-08-17 09:00, 2023-08-17 11:20
    Installation de Gatling : done, mise-en-place-g, 2023-08-17 11:30, 2023-08-17 12:30
    Lecture de documentation INA219 : done, mise-en-place-h, 2023-08-17 12:45, 2023-08-18 02:45
    Préparation de l'INA219 : done, mise-en-place-i, 2023-08-18 03:00, 2023-08-18 15:00
    Mise en place d'un serveur Apache : done, mise-en-place-j, 2023-08-18 15:30, 2023-08-18 17:00

</div></code></pre>
<pre><code class="language-mermaid"><div class="mermaid">gantt
    dateFormat  YYYY-MM-DD HH:mm
    title       Planning du Projet
    excludes    weekends
    axisFormat %Y-%m-%a %H:%M
    tickInterval 4 hour
    section Première Itération

    Configuration de Node-Red : mise-en-place-d1, 2023-08-21 08:00, 2023-08-21 16:00
    Configurer Gatling : mise-en-place-d2, 2023-08-22 08:00, 2023-08-22 16:00
    Configuration et test de relevé de l'INA219 : mise-en-place-d3, 2023-08-23 08:00, 2023-08-23 09:00
    Création de PDF avec Node-Red : mise-en-place-d4, 2023-08-24 08:00, 2023-08-24 08:00
    Agrégation du lancement des tests et des relevés de l'INA219 : mise-en-place-d5, 2023-08-25 08:00, 2023-08-25 16:00
    Réinstallation de Volt : mise-en-place-d6, 2023-08-26 08:00, 2023-08-26 10:00
    Passage du SSH au MQTT pour la récupération des infos : mise-en-place-d7, 2023-08-27 08:00, 2023-08-27 12:00

</div></code></pre>
<h1 id="5-instalation-physique">5. Instalation physique</h1>
<h2 id="51-nidus">5.1. Nidus</h2>
<img src="../capture/Nidus.jpg" alt="Image" width="100%" style="width:100%;">
<h2 id="52-volt">5.2. Volt</h2>
<img src="../capture/Volt.jpg" alt="Image" width="100%" style="width:100%;">
<div style="page-break-after: always;"></div>
<h1 id="6-sh%C3%A9ma-de-principe">6. Shéma de principe</h1>
<pre class="hljs"><code><div>                    +---------+      +-------------+
                    |   Volt  |      |   Nidus     |
                    |_________|      |_____________|
                    |  RPI 4  |      |  RPI 4      |
                    |_________|      |_____________|
                    | Apache  |      | Node-RED    |
                    | No-Proc |      | Gatling     |
                    |         |      | INA219      |
                    |         |      | MQTT        |
                    +---------+      +-------------+
                        ^   |             ^   |
                        |   |             |   |
                        |   |             |   |
                        |   |             |   |
                        |   v             |   v
                    +-----------------------------+
                    |       Réseau local          |
                    +---+-------------------+-----+
                        | Dashboard Node-Red|
                        +-------------------+
                                    ^
                                    |
                                    |
                            +------------+
                            |Utilisateur |
                            +------------+

</div></code></pre>
<p>Explication : Actuellement le but est que Nidus offre tout les outil pour le monittoring incluant le MQTT, Node-Red, Gatling et l'INA219. Volt lui ne sert que de serveur web pour le site web. Le but est de pouvoir faire des test de charge sur le site web et de pouvoir mesurer la consommation électrique du serveur web.<br>
De fais toute intéraction de l'utilisateur se fait avec Nidus.<br>
Nidus envoie ses donnée de monittoring sur le serveur MQTT installé sur Nidus, et Node-Red installé sur Nidus récupère les données du serveur MQTT et les envoie dans des noeud fais pour le traiter et fournir ensuite les sortie appropié :</p>
<ul>
<li>Dashboard : Pour l'utilisateur</li>
<li>PDF : Pour l'utilisateur<br>
Nidus peut dans un second temps lancer des stresstest via Node-Red sur lui même et sur Volt. Il peut aussi lancer des stresstest sur Volt via Gatling.</li>
</ul>
<pre><code class="language-mermaid"><div class="mermaid">graph TD;

subgraph "Serveur"
    A[Site Web] -->|Requêtes| B[Node-RED];
    B -->|MQTT| C[INA219];
    B -->|MQTT| D[Gatling];
end

subgraph "Raspberry Pi"
    E[Nidus] -->|I2C| G[INA219 Mesure];
    F[Volt] -->|I2C| H[INA219 Remplacement];
end

subgraph "Utilisateur"
    I[Dashboard Node-Red];
end

A -->|Requêtes| B;
B -->|MQTT| C;
B -->|MQTT| D;
E -->|I2C| G;
F -->|I2C| H;
B -->|MQTT| I;
I -->|Données Moniteur| I;

</div></code></pre>
<div style="page-break-after: always;"></div>
<h1 id="7-syst%C3%A8mes-dexploitation-os">7. Systèmes d'exploitation (OS)</h1>
<p>Dans le cadre de ce projet, plusieurs systèmes d'exploitation seront utilisés. Pour commencer, nous utiliserons Ubuntu.</p>
<h2 id="71-ubuntu">7.1. Ubuntu</h2>
<p>Ubuntu est un système d'exploitation largement utilisé pour les serveurs et les ordinateurs de bureau. Il est livré avec un ensemble d'outils de développement et de productivité, notamment un navigateur Web, un éditeur de texte, des logiciels de programmation, des outils de calcul, des jeux et des logiciels de productivité. Ubuntu propose un environnement de bureau léger et réactif, conçu tant pour les ordinateurs de bureau que pour les serveurs.</p>
<h2 id="72-raspbian">7.2. Raspbian</h2>
<p>Raspbian est un système d'exploitation libre basé sur Debian, spécialement optimisé pour le Raspberry Pi. Depuis 2015, Raspbian est livré avec un ensemble d'outils appelé Pixel. Pixel offre un environnement de bureau comprenant un navigateur Web, un éditeur de texte, des logiciels de programmation, des outils de calcul, des jeux et des logiciels de productivité. Pixel est un environnement de bureau léger et réactif, conçu spécifiquement pour les ordinateurs monocarte Raspberry Pi.</p>
<h2 id="73-premi%C3%A8re-installation">7.3. Première installation</h2>
<p>Dans un premier temps, nous allons installer la version bureau d'Ubuntu sur Volt. Cette décision est motivée par le fait qu'il est plus simple de travailler dans un environnement de bureau pour tester rapidement tous les concepts du projet.</p>
<p>Sur Nidus, Raspbian en version bureau sera installé pour des raisons similaires à celles de Volt.</p>
<p>Un élément crucial à noter est que, étant donné que l'INA219 sera connecté à Nidus, il est plus pratique d'installer Raspbian sur Nidus afin d'avoir accès aux broches GPIO.</p>
<p>Dans un second temps, pour obtenir des mesures plus précises, nous installerons les versions « core » d'Ubuntu et de Raspbian.</p>
<p>Adresse IP de Volt : 157.26.228.77<br>
Adresse IP de Nidus : 157.26.251.185</p>
<h2 id="74-seconde-instalation-ubuntu-server">7.4. Seconde instalation Ubuntu Server</h2>
<img src="../capture/RPI/Volt/Imager.png" alt="Image" width="100%" style="width:100%;">
<div style="page-break-after: always;"></div>
<h3 id="741-configuration-post-instalation">7.4.1. Configuration post instalation</h3>
<pre class="hljs"><code><div>toblerc@LPT-UNIX-USB-CT:~$ ssh tobby@157.26.228.77
The authenticity of host <span class="hljs-string">'157.26.228.77 (157.26.228.77)'</span> can<span class="hljs-string">'t be established.
ED25519 key fingerprint is SHA256:/5raLlKqk0A4AnFWnLP9bagNS3zKE9rFPqn5vA5pc+M.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>157.26.228.77<span class="hljs-string">' (ED25519) to the list of known hosts.
tobby@157.26.228.77'</span>s password: 
Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 5.15.0-1034-raspi aarch64)

[...]

tobby@Volt:~$ ls -la
total 28&gt; 2022 .bash_logout
-rw-r--r-- 1 tobby tobby 3771 Jan  6  2022 .bashrc
drwx------ 2 tobby tobby 4096 Aug 23 09:29 .cache
-rw-r--r-- 1 tobby tobby  807 Jan  6  2022 .profile
drwx------ 2 tobby tobby 4096 Aug 23 09:30 .ssh
tobby@Volt:~$ <span class="hljs-built_in">cd</span> .ssh/
tobby@Volt:~/.ssh$ ls -la
total 8
drwx------ 2 tobby tobby 4096 Aug 23 09:30 .
drwxr-x--- 4 tobby tobby 4096 Aug 23 09:30 ..
-rw------- 1 tobby tobby    0 Aug 23 09:30 authorized_keys
tobby@Volt:~/.ssh$ sudo vi authorized_keys 
[sudo] password <span class="hljs-keyword">for</span> tobby: 
tobby@Volt:~/.ssh$ <span class="hljs-built_in">exit</span>
<span class="hljs-built_in">logout</span>
Connection to 157.26.228.77 closed.
toblerc@LPT-UNIX-USB-CT:~$ ssh tobby@157.26.228.77
Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 5.15.0-1034-raspi aarch64)

[...]

Last login: Wed Aug 23 09:30:02 2023 from 157.26.215.31
tobby@Volt:~$ sudo apt update &amp;&amp; sudo apt upgrade -y &amp;&amp; sudo apt dist-upgrade -y &amp;&amp; sudo apt autzo-remove -y
[sudo] password <span class="hljs-keyword">for</span> tobby: 
[...]
tobby@Volt:~$ sudo apt update &amp;&amp; sudo apt upgrade -y &amp;&amp; sudo apt dist-upgrade -y &amp;&amp; sudo apt auto-remove -y

[...]


0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.

</div></code></pre>
<h3 id="742-instalation-apache">7.4.2. Instalation Apache</h3>
<pre class="hljs"><code><div>tobby@Volt:~$ sudo apt install apache2
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  apache2-bin apache2-data apache2-utils bzip2 libapr1 li
[...]

</div></code></pre>
<pre class="hljs"><code><div>toblerc@LPT-UNIX-USB-CT:~$ scp -r /home/toblerc/Documents/ES_2024/banc-de-mesures-de-la-consommation-electrique/siteWeb/www/html tobby@157.26.228.77://home/tobby
[...]   
toblerc@LPT-UNIX-USB-CT:~$ 
tobby@Volt:~$ sudo cp -r /home/tobby/html /var/www/
</div></code></pre>
<h3 id="743-script-mqtt">7.4.3. Script MQTT</h3>
<pre class="hljs"><code><div>toblerc@LPT-UNIX-USB-CT:~/Documents/ES_2024/banc-de-mesures-de-la-consommation-electrique$ scp ./mqtt.sh tobby@157.26.228.77:/home/tobby
mqtt.sh                                                                                                                                                                         100% 2522     1.7MB/s   00:00    
toblerc@LPT-UNIX-USB-CT:~/Documents/ES_2024/banc-de-mesures-de-la-consommation-electrique$ 
tobby@Volt:~$ sudo cp ./mqtt.sh /usr/<span class="hljs-built_in">local</span>/bin/
tobby@Volt:~$ ls -la /usr/<span class="hljs-built_in">local</span>/bin/
total 12
drwxr-xr-x  2 root root 4096 Aug 23 10:26 .
drwxr-xr-x 10 root root 4096 Aug  7 17:23 ..
-rw-r--r--  1 root root 2522 Aug 23 10:26 mqtt.sh
</div></code></pre>
<pre class="hljs"><code><div>tobby@Volt:/usr/<span class="hljs-built_in">local</span>/bin$ sudo ./mqtt.sh 
Installation de mosquitto-clients...
Hit:1 http://ports.ubuntu.com/ubuntu-ports jammy InRelease
Get:2 http://ports.ubuntu.com/ubuntu-ports jammy-updates InRelease [119 kB]
Hit:3 http://ports.ubuntu.com/ubuntu-ports jammy-backports InRelease
Get:4 http://ports.ubuntu.com/ubuntu-ports jammy-security InRelease [110 kB]
Fetched 229 kB <span class="hljs-keyword">in</span> 2s (133 kB/s)    
Reading package lists... Done
Reading package lists... Done
Building dependency tree... Done
[...]

</div></code></pre>
<div style="page-break-after: always;"></div>
<h1 id="8-node-red">8. Node-RED</h1>
<p><strong>Node-RED</strong> est un outil de programmation visuelle open source conçu pour faciliter la connexion de périphériques, d'API et de services en ligne. Il propose un éditeur de flux basé sur un navigateur, permettant ainsi de connecter des nœuds à l'aide de simples glisser-déposer. Ces nœuds peuvent être exécutés dans un environnement Node.js. Ils peuvent être des fonctions JavaScript ou des modules npm, tels que node-red-contrib-gpio, node-red-contrib-sqlite, node-red-contrib-modbustcp, etc. En plus des nœuds de base fournis, Node-RED offre plus de 2000 nœuds supplémentaires créés par la communauté et prêts à être utilisés.</p>
<h2 id="81-instalation">8.1. Instalation</h2>
<pre class="hljs"><code><div>tobby@Nidus:~ $ bash &lt;(curl -sL https://raw.githubusercontent.com/node-red/linux-installers/master/deb/update-nodejs-and-nodered)
Running Node-RED install <span class="hljs-keyword">for</span> user tobby at /home/tobby on debian


This can take 20-30 minutes on the slower Pi versions - please <span class="hljs-built_in">wait</span>.

  Stop Node-RED                       ✔
  Remove old version of Node-RED      ✔
  Remove old version of Node.js       ✔   
  Install Node.js 18 LTS              ✔   v18.17.1   Npm 9.6.7
  Clean npm cache                     ✔
  Install Node-RED core               ✔   3.0.2
  Move global nodes to <span class="hljs-built_in">local</span>          -
  Npm rebuild existing nodes          ✔
  Install extra Pi nodes              ✔
  Add shortcut commands               ✔
  Update systemd script               ✔
                                      

Any errors will be logged to   /var/<span class="hljs-built_in">log</span>/nodered-install.log
All <span class="hljs-keyword">done</span>.
You can now start Node-RED with the <span class="hljs-built_in">command</span>  node-red-start
  or using the icon under   Menu / Programming / Node-RED
Then point your browser to localhost:1880 or http://{your_pi_ip-address}:1880

Started :  mer 16 aoû 2023 14:12:19 CEST 
Finished:  mer 16 aoû 2023 14:16:01 CEST
 
**********************************************************************************
 <span class="hljs-comment">### WARNING ###</span>
 DO NOT EXPOSE NODE-RED TO THE OPEN INTERNET WITHOUT SECURING IT FIRST
 
 Even <span class="hljs-keyword">if</span> your Node-RED doesn<span class="hljs-string">'t have anything valuable, (automated) attacks will
 happen and could provide a foothold in your local network
 
 Follow the guide at https://nodered.org/docs/user-guide/runtime/securing-node-red
 to setup security.
 
 ### ADDITIONAL RECOMMENDATIONS ###
  - Remove the /etc/sudoers.d/010_pi-nopasswd file to require entering your password
    when performing any sudo/root commands:
 
      sudo rm -f /etc/sudoers.d/010_pi-nopasswd
 
  - You can customise the initial settings by running:
 
      node-red admin init
 
  - After running Node-RED for the first time, change the ownership of the settings
    file to '</span>root<span class="hljs-string">' to prevent unauthorised changes:
 
      sudo chown root:root ~/.node-red/settings.js
 
**********************************************************************************
 
  Would you like to customise the settings now (y/N) ? y

Node-RED Settings File initialisation
=====================================
This tool will help you create a Node-RED settings file.

✔ Settings file · /home/tobby/.node-red/settings.js

User Security
=============
✔ Do you want to setup user security? · Yes
✔ Username · Tobby
✔ Password · ***********
✔ User permissions · full access
✔ Add another user? · Yes
✔ Username · FMA
✔ Password · ******** (Pa$$w.rd)
✔ User permissions · read-only access
✔ Add another user? · Yes
✔ Username · BVI
✔ Password · ******** (Pa$$w.rd)
✔ User permissions · read-only access
✔ Add another user? · No

Projects
========
The Projects feature allows you to version control your flow using a local git repository.

✔ Do you want to enable the Projects feature? · No

Flow File settings
==================
✔ Enter a name for your flows file · flows.json
✔ Provide a passphrase to encrypt your credentials file · 

Editor settings
===============
✔ Select a theme for the editor. To use any theme other than "default", you will need to install @node-red-contrib-themes/theme-collection in your Node-RED user directory. · dark
✔ Select the text editor component to use in the Node-RED Editor · monaco (default)

Node settings
=============
✔ Allow Function nodes to load external modules? (functionExternalModules) · Yes


Settings file written to /home/tobby/.node-red/settings.js
To use the '</span>dark<span class="hljs-string">' editor theme, remember to install @node-red-contrib-themes/theme-collection in your Node-RED user directory

tobby@Nidus:~ $ sudo systemctl enable nodered.service
Created symlink /etc/systemd/system/multi-user.target.wants/nodered.service → /lib/systemd/system/nodered.service.

</span></div></code></pre>
<img src="../capture/RPI/Node-Red/PostInstall.png" alt="Image" width="100%" style="width:100%;">
<h2 id="82-configuration">8.2. Configuration</h2>
<h3 id="821-installation-des-plugins">8.2.1. Installation des plugins</h3>
<img src="../capture/RPI/Node-Red/palette1.png" alt="Installation des plugins" width="30%" style="width:30%;">
<img src="../capture/RPI/Node-Red/palette2.png" alt="Installation des plugins" width="30%" style="width:30%;">
<img src="../capture/RPI/Node-Red/palette3.png" alt="Installation des plugins" width="30%" style="width:30%;">
<img src="../capture/RPI/Node-Red/palette4.png" alt="Installation des plugins" width="100%" style="width:100%;">
<img src="../capture/RPI/Node-Red/Dashboard.png" alt="Installation des plugins" width="100%" style="width:100%;">
<h3 id="822-s%C3%A9curisation-de-node-red">8.2.2. Sécurisation de Node-Red</h3>
<p>Pour sécuriser Node-Red, il convient de modifier le fichier <code>settings.js</code>. Dans notre cas, nous utilisons la commande <code>node-red admin init</code>, ce qui permet, par exemple, de créer des paires utilisateur/mot de passe.</p>
<p>De plus, il est recommandé, si nécessaire, d'ajouter un login au <em>Dashboard</em>.</p>
<h3 id="823-suivi-git">8.2.3. Suivi Git</h3>
<p>Afin de suivre le projet sur Git, il est nécessaire de configurer un utilisateur, générer des clés SSH, puis effectuer un <em>clone</em> du projet.</p>
<img src="../capture/RPI/Node-Red/Git_Config.png" alt="Configuration Git" width="30%" style="width:30%;">
<img src="../capture/RPI/Node-Red/GIT_Open.png" alt="Ouvrir le projet sur Git" width="30%" style="width:30%;">
<img src="../capture/RPI/Node-Red/GIT_Setting.png" alt="Configuration Git" width="30%" style="width:30%;">
<p>Comme il s'agit d'un <em>clone</em>, il faudra ajouter les fichiers manquants et ajuster les droits d'accès.</p>
<pre class="hljs"><code><div>tobby@Nidus:~/.node-red/projects/banc-de-mesures-de-la-consommation-electrique $ touch ~/.node-red/projects/banc-de-mesures-de-la-consommation-electrique/flows_cred.json
tobby@Nidus:~/.node-red/projects/banc-de-mesures-de-la-consommation-electrique $ chmod 600 ~/.node-red/projects/banc-de-mesures-de-la-consommation-electrique/flows_cred.json

</div></code></pre>
<div style="page-break-after: always;"></div>
<h1 id="9-gatling">9. Gatling</h1>
<p><strong>Gatling</strong> est un outil de test de charge open source basé sur Scala, conçu pour évaluer les performances des applications et des sites Web. Gatling simule des utilisateurs virtuels qui envoient des requêtes HTTP vers le système cible. Il enregistre les temps de réponse des requêtes et les présente sous forme de graphiques. Gatling est doté d'un éditeur de scénarios basé sur navigateur, permettant aux utilisateurs de créer des scénarios de test de charge à l'aide d'un langage de domaine spécifique (DSL) appelé <em>Gatling DSL</em>. Ce langage, basé sur Scala, permet de définir des scénarios de test de charge à l'aide de mots-clés tels que <code>exec</code>, <code>pause</code>, <code>feed</code>, etc.</p>
<p>La version la plus récente de Gatling est la 3.9.5, compatible avec Java 8 et Java 11. Dans ce projet, nous opterons pour Java 11 pour exécuter Gatling.</p>
<h2 id="91-installation">9.1. Installation</h2>
<h3 id="911-prerequis">9.1.1. Prerequis</h3>
<pre class="hljs"><code><div>tobby@Nidus:~ $ sudo apt install default-jdk
tobby@Nidus:~/.node-red $ java -version
openjdk version <span class="hljs-string">"11.0.18"</span> 2023-01-17
OpenJDK Runtime Environment (build 11.0.18+10-post-Debian-1deb11u1)
OpenJDK 64-Bit Server VM (build 11.0.18+10-post-Debian-1deb11u1, mixed mode)
tobby@Nidus:~/.node-red $ 


</div></code></pre>
<h3 id="912-download">9.1.2. Download</h3>
<pre class="hljs"><code><div>tobby@Nidus:~ $ mkdir .gatling
tobby@Nidus:~ $ ls -la
total 104
drwxr-xr-x 18 tobby tobby 4096 16 aoû 15:10 .
drwxr-xr-x  3 root  root  4096 16 aoû 13:58 ..

[...]

drwxr-xr-x  2 tobby tobby 4096 16 aoû 15:10 .gatling

[...]

tobby@Nidus:~ $ wget -O ~/.gatling/gatling-charts-highcharts-bundle-3.9.5-bundle.zip https://repo1.maven.org/maven2/io/gatling/highcharts/gatling-charts-highcharts-bundle/3.9.5/gatling-charts-highcharts-bundle-3.9.5-bundle.zip
--2023-08-16 15:12:41--  https://repo1.maven.org/maven2/io/gatling/highcharts/gatling-charts-highcharts-bundle/3.9.5/gatling-charts-highcharts-bundle-3.9.5-bundle.zip
Résolution de repo1.maven.org (repo1.maven.org)… 146.75.116.209, 2a04:4e42:8d::209
Connexion à repo1.maven.org (repo1.maven.org)|146.75.116.209|:443… connecté.
requête HTTP transmise, en attente de la réponse… 200 OK
Taille : 77080673 (74M) [application/zip]
Sauvegarde en : « /home/tobby/.gatling/gatling-charts-highcharts-bundle-3.9.5-bundle.zip »

/home/tobby/.gatling/gatling-charts-highcharts-bundl 100%[====================================================================================================================&gt;]  73.51M  11.0MB/s    ds 5.8s    

2023-08-16 15:12:47 (12.8 MB/s) — « /home/tobby/.gatling/gatling-charts-highcharts-bundle-3.9.5-bundle.zip » sauvegardé [77080673/77080673]

tobby@Nidus:~ $ unzip ~/.gatling/gatling-charts-highcharts-bundle-3.9.5-bundle.zip -d ~/.gatling/
Archive:  /home/tobby/.gatling/gatling-charts-highcharts-bundle-3.9.5-bundle.zip

[...]

  inflating: /home/tobby/.gatling/gatling-charts-highcharts-bundle-3.9.5/LICENSE  
tobby@Nidus:~ $ <span class="hljs-built_in">cd</span> .gatling/
tobby@Nidus:~/.gatling $ ls -la
total 75288
drwxr-xr-x  3 tobby tobby     4096 16 aoû 15:12 .
drwxr-xr-x 18 tobby tobby     4096 16 aoû 15:10 ..
drwxr-xr-x  7 tobby tobby     4096 10 mai 11:19 gatling-charts-highcharts-bundle-3.9.5
-rw-r--r--  1 tobby tobby 77080673 10 mai 11:19 gatling-charts-highcharts-bundle-3.9.5-bundle.zip
tobby@Nidus:~/.gatling $ <span class="hljs-built_in">cd</span> gatling-charts-highcharts-bundle-3.9.5/
tobby@Nidus:~/.gatling/gatling-charts-highcharts-bundle-3.9.5 $ ls -la
total 48
drwxr-xr-x 7 tobby tobby  4096 10 mai 11:19 .
drwxr-xr-x 3 tobby tobby  4096 16 aoû 15:12 ..
drwxr-xr-x 2 tobby tobby  4096 10 mai 11:19 bin
drwxr-xr-x 2 tobby tobby  4096 10 mai 11:19 conf
drwxr-xr-x 2 tobby tobby 12288 10 mai 11:19 lib
-rw-r--r-- 1 tobby tobby 11367 10 mai 11:19 LICENSE
drwxr-xr-x 2 tobby tobby  4096 10 mai 11:19 results
drwxr-xr-x 5 tobby tobby  4096 10 mai 11:19 user-files
</div></code></pre>
<h2 id="92-v%C3%A9rification-de-linstallation">9.2. Vérification de l'installation</h2>
<pre class="hljs"><code><div>tobby@Nidus:~/.gatling/gatling-charts-highcharts-bundle-3.9.5/bin $ ./gatling.sh
GATLING_HOME is <span class="hljs-built_in">set</span> to /home/tobby/.gatling/gatling-charts-highcharts-bundle-3.9.5
Do you want to run the simulation locally, on Gatling Enterprise, or just package it?
Type the number corresponding to your choice and press enter
[0] &lt;Quit&gt;
[1] Run the Simulation locally
[2] Package and upload the Simulation to Gatling Enterprise Cloud, and run it there
[3] Package the Simulation <span class="hljs-keyword">for</span> Gatling Enterprise
[4] Show <span class="hljs-built_in">help</span> and <span class="hljs-built_in">exit</span>
1
août 16, 2023 4:28:28 PM java.util.prefs.FileSystemPreferences<span class="hljs-variable">$1</span> run
INFO: Created user preferences directory.
computerdatabase.ComputerDatabaseSimulation is the only simulation, executing it.
Select run description (optional)
InstallVerif
Simulation computerdatabase.ComputerDatabaseSimulation started...

[...]

Simulation computerdatabase.ComputerDatabaseSimulation completed <span class="hljs-keyword">in</span> 17 seconds
Parsing <span class="hljs-built_in">log</span> file(s)...
Parsing <span class="hljs-built_in">log</span> file(s) <span class="hljs-keyword">done</span>
Generating reports...

================================================================================
---- Global Information --------------------------------------------------------
&gt; request count                                        108 (OK=105    KO=3     )
&gt; min response time                                    108 (OK=108    KO=111   )
&gt; max response time                                   1563 (OK=1563   KO=114   )
&gt; mean response time                                   162 (OK=163    KO=112   )
&gt; std deviation                                        168 (OK=170    KO=1     )
&gt; response time 50th percentile                        115 (OK=115    KO=112   )
&gt; response time 75th percentile                        120 (OK=121    KO=113   )
&gt; response time 95th percentile                        351 (OK=352    KO=114   )
&gt; response time 99th percentile                        620 (OK=620    KO=114   )
&gt; mean requests/sec                                  6.353 (OK=6.176  KO=0.176 )
---- Response Time Distribution ------------------------------------------------
&gt; t &lt; 800 ms                                           104 ( 96%)
&gt; 800 ms &lt;= t &lt; 1200 ms                                  0 (  0%)
&gt; t &gt;= 1200 ms                                           1 (  1%)
&gt; failed                                                 3 (  3%)
---- Errors --------------------------------------------------------------------
&gt; status.find.is(201), but actually found 200                         3 (100,0%)
================================================================================

Reports generated <span class="hljs-keyword">in</span> 0s.
Please open the following file: file:///home/tobby/.gatling/gatling-charts-highcharts-bundle-3.9.5/results/computerdatabasesimulation-20230816142907884/index.html
</div></code></pre>
<h2 id="93-scripts">9.3. Scripts</h2>
<p>Pour Gatling, j'ai d'abord choisi le Java comme language de programmation mais je me suis tournée ensuite vers le Scala car il est plus adapté à Gatling. J'ai donc créé un script Scala qui permet de faire un test de charge sur le site web. Ce script est très simple, il se contente de faire une requête GET sur la page d'accueil du site web. Il est possible de modifier le nombre d'utilisateur et le temps de test dans le script. J'ai aussi créé un script bash qui permet de lancer le script Scala.</p>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> io.gatling.core.<span class="hljs-type">Predef</span>._
<span class="hljs-keyword">import</span> io.gatling.http.<span class="hljs-type">Predef</span>._
<span class="hljs-keyword">import</span> scala.concurrent.duration._

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CuriusTRex_Bash</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Simulation</span> </span>{

  <span class="hljs-keyword">val</span> httpProtocol = http
    .baseUrl(<span class="hljs-string">"http://volt.s2.rpn.ch"</span>)
    .inferHtmlResources()
    .acceptHeader(<span class="hljs-string">"image/avif,image/webp,*/*"</span>)
    .acceptEncodingHeader(<span class="hljs-string">"gzip, deflate"</span>)
    .acceptLanguageHeader(<span class="hljs-string">"fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3"</span>)
    .userAgentHeader(<span class="hljs-string">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/114.0"</span>)

  <span class="hljs-keyword">val</span> headers_0 = <span class="hljs-type">Map</span>(
    <span class="hljs-string">"Accept"</span> -&gt; <span class="hljs-string">"text/css,*/*;q=0.1"</span>,
    <span class="hljs-string">"If-Modified-Since"</span> -&gt; <span class="hljs-string">"Thu, 17 Aug 2023 08:18:41 GMT"</span>,
    <span class="hljs-string">"If-None-Match"</span> -&gt; <span class="hljs-string">"\"dc3-6031a0f5b4a47-gzip\""</span>
  )

  <span class="hljs-keyword">val</span> headers_1 = <span class="hljs-type">Map</span>(
    <span class="hljs-string">"Accept"</span> -&gt; <span class="hljs-string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8"</span>,
    <span class="hljs-string">"Upgrade-Insecure-Requests"</span> -&gt; <span class="hljs-string">"1"</span>
  )

  <span class="hljs-keyword">val</span> headers_4 = <span class="hljs-type">Map</span>(
    <span class="hljs-string">"If-Modified-Since"</span> -&gt; <span class="hljs-string">"Thu, 17 Aug 2023 07:26:33 GMT"</span>,
    <span class="hljs-string">"If-None-Match"</span> -&gt; <span class="hljs-string">"\"164ac-6031954e8df3b\""</span>
  )

  <span class="hljs-keyword">val</span> headers_6 = <span class="hljs-type">Map</span>(
    <span class="hljs-string">"If-Modified-Since"</span> -&gt; <span class="hljs-string">"Thu, 17 Aug 2023 07:26:33 GMT"</span>,
    <span class="hljs-string">"If-None-Match"</span> -&gt; <span class="hljs-string">"\"14c4c-6031954e8cf9b\""</span>
  )

  <span class="hljs-keyword">val</span> headers_7 = <span class="hljs-type">Map</span>(
    <span class="hljs-string">"Accept"</span> -&gt; <span class="hljs-string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8"</span>,
    <span class="hljs-string">"If-Modified-Since"</span> -&gt; <span class="hljs-string">"Thu, 17 Aug 2023 08:08:51 GMT"</span>,
    <span class="hljs-string">"If-None-Match"</span> -&gt; <span class="hljs-string">"\"2129-60319ec28bede-gzip\""</span>,
    <span class="hljs-string">"Upgrade-Insecure-Requests"</span> -&gt; <span class="hljs-string">"1"</span>
  )

  <span class="hljs-keyword">val</span> scn = scenario(<span class="hljs-string">"CuriusTRex"</span>)
    .exec(
      http(<span class="hljs-string">"request_0"</span>)
        .get(<span class="hljs-string">"/styles.css"</span>)
        .headers(headers_0)
    )
    <span class="hljs-comment">// Start</span>
    .exec(
      http(<span class="hljs-string">"request_1"</span>)
        .get(<span class="hljs-string">"/contact.html"</span>)
        .headers(headers_1)
    )
    .exec(
      http(<span class="hljs-string">"request_2"</span>)
        .get(<span class="hljs-string">"/about.html"</span>)
        .headers(headers_1)
        .resources(
          http(<span class="hljs-string">"request_3"</span>)
            .get(<span class="hljs-string">"/capture/Home.jpg"</span>),
          http(<span class="hljs-string">"request_4"</span>)
            .get(<span class="hljs-string">"/capture/Test_Complet.jpg"</span>)
            .headers(headers_4),
          http(<span class="hljs-string">"request_5"</span>)
            .get(<span class="hljs-string">"/capture/Donn%C3%A9es.jpg"</span>),
          http(<span class="hljs-string">"request_6"</span>)
            .get(<span class="hljs-string">"/capture/Test.jpg"</span>)
            .headers(headers_6)
        )
    )
    .exec(
      http(<span class="hljs-string">"request_7"</span>)
        .get(<span class="hljs-string">"/about.html"</span>)
        .headers(headers_7)
    )
   .exec(flushHttpCache)
   .exec(flushSessionCookies)
   .exec(flushCookieJar)

<span class="hljs-keyword">val</span> nbUsers = java.lang.<span class="hljs-type">Long</span>.getLong(<span class="hljs-string">"users"</span>, <span class="hljs-number">1</span>).toDouble
<span class="hljs-keyword">val</span> myRamp = java.lang.<span class="hljs-type">Long</span>.getLong(<span class="hljs-string">"ramp"</span>, <span class="hljs-number">0</span>)
println(<span class="hljs-string">s"Nombre d'utilisateurs : <span class="hljs-subst">$nbUsers</span>"</span>)
println(<span class="hljs-string">s"Temps de montée : <span class="hljs-subst">$myRamp</span>"</span>)

  setUp(scn.inject(constantUsersPerSec(nbUsers).during(myRamp seconds))).protocols(httpProtocol)
}

</div></code></pre>
<div style="page-break-after: always;"></div>
<h1 id="10-apache-et-site-web">10. Apache et Site Web</h1>
<h2 id="101-installation">10.1. Installation</h2>
<pre class="hljs"><code><div>sudo apt install apache2
sudo systemctl status apache2
sudo systemctl <span class="hljs-built_in">enable</span> apache2
</div></code></pre>
<h2 id="102-mise-en-place-dun-site-web">10.2. Mise en place d'un site Web</h2>
<p>J'ai créee un site web très simple reprenant le readme du projet. Et il comporte trois pages ainsi que du CSS.</p>
<pre class="hljs"><code><div>scp -r /home/toblerc/Documents/ES_2024/banc-de-mesures-de-la-consommation-electrique/siteWeb/www/html tobby@Volt:/var/www/html/
</div></code></pre>
<div style="page-break-after: always;"></div>
<h1 id="11-mqtt">11. MQTT</h1>
<p>Dans notre cas, j'ai l'intention d'utiliser MQTT pour transmettre les données de consommation à Node-Red. En contournant le transfert de requêtes via SSH et l'utilisation de clés SSH, MQTT permet de gagner en performances et en sécurité. En termes de performances, MQTT est considérablement plus léger que SSH, environ dix fois plus léger.</p>
<h2 id="111-installation-de-mosquitto-sur-nidus">11.1. Installation de Mosquitto sur Nidus</h2>
<pre class="hljs"><code><div>tobby@Nidus:~/.ssh $ sudo apt install mosquitto
Lecture des listes de paquets... Fait
[...]
tobby@Nidus:~/.ssh $ sudo systemctl status mosquitto
● mosquitto.service - Mosquitto MQTT Broker
     Loaded: loaded (/lib/systemd/system/mosquitto.service; enabled; vendor preset: enabled)
     Active: active (running) since Tue 2023-08-22 16:01:58 CEST; 7s ago
       Docs: man:mosquitto.conf(5)
             man:mosquitto(8)
    Process: 22571 ExecStartPre=/bin/mkdir -m 740 -p /var/<span class="hljs-built_in">log</span>/mosquitto (code=exited, status=0/SUCCESS)
    Process: 22572 ExecStartPre=/bin/chown mosquitto /var/<span class="hljs-built_in">log</span>/mosquitto (code=exited, status=0/SUCCESS)
    Process: 22573 ExecStartPre=/bin/mkdir -m 740 -p /run/mosquitto (code=exited, status=0/SUCCESS)
    Process: 22574 ExecStartPre=/bin/chown mosquitto /run/mosquitto (code=exited, status=0/SUCCESS)
   Main PID: 22575 (mosquitto)
      Tasks: 1 (<span class="hljs-built_in">limit</span>: 3933)
        CPU: 42ms
     CGroup: /system.slice/mosquitto.service
             └─22575 /usr/sbin/mosquitto -c /etc/mosquitto/mosquitto.conf

aoû 22 16:01:58 Nidus systemd[1]: Starting Mosquitto MQTT Broker...
aoû 22 16:01:58 Nidus systemd[1]: Started Mosquitto MQTT Broker.
</div></code></pre>
<h2 id="112-ouverture-des-port-sur-nidus">11.2. Ouverture des port sur Nidus</h2>
<p>Modifier le fichier de conf comme suit :</p>
<pre class="hljs"><code><div>tobby@Nidus:~ $ sudo vim /etc/mosquitto/mosquitto.conf
tobby@Nidus:~ $ sudo cat /etc/mosquitto/mosquitto.conf 
<span class="hljs-comment"># Place your local configuration in /etc/mosquitto/conf.d/</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># A full description of the configuration file is at</span>
<span class="hljs-comment"># /usr/share/doc/mosquitto/examples/mosquitto.conf.example</span>

pid_file /run/mosquitto/mosquitto.pid

persistence <span class="hljs-literal">true</span>
persistence_location /var/lib/mosquitto/

log_dest file /var/<span class="hljs-built_in">log</span>/mosquitto/mosquitto.log

include_dir /etc/mosquitto/conf.d

listener 1883
allow_anonymous <span class="hljs-literal">true</span>
</div></code></pre>
<div style="page-break-after: always;"></div>
<h2 id="113-script-mqtt">11.3. Script MQTT</h2>
<p>J'ai élaboré un script MQTT sophistiqué, conçu pour publier efficacement les données de consommation sur le broker MQTT. Ce script, au démarrage de la machine, entreprend un fonctionnement en boucle continue, garantissant la collecte et la publication régulières de ces données. L'objectif est d'optimiser les performances tout en garantissant la fiabilité du processus.</p>
<h3 id="1131-script">11.3.1. Script</h3>
<pre class="hljs"><code><div><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment">### BEGIN INIT INFO</span>
<span class="hljs-comment"># Provides:          mqtt</span>
<span class="hljs-comment"># Required-Start:    $remote_fs $syslog</span>
<span class="hljs-comment"># Required-Stop:     $remote_fs $syslog</span>
<span class="hljs-comment"># Default-Start:     2 3 4 5</span>
<span class="hljs-comment"># Default-Stop:      0 1 6</span>
<span class="hljs-comment"># Short-Description: Script MQTT de collecte de données</span>
<span class="hljs-comment"># Description:       Ce script collecte la charge CPU, la charge RAM</span>
<span class="hljs-comment">#                    et le nombre de processus, puis publie ces données</span>
<span class="hljs-comment">#                    sur un broker MQTT.</span>
<span class="hljs-comment">### END INIT INFO</span>

<span class="hljs-comment"># Pour ajouter les droits d'exécution : </span>
<span class="hljs-comment"># chmod +x mqtt.sh</span>
<span class="hljs-comment"># Pour le copier depuis Nidus vers Volt :</span>
<span class="hljs-comment"># scp ./mqtt.sh tobby@volt:/usr/local/bin/mqtt.sh</span>
<span class="hljs-comment"># Emplacement du script (doit être dans /usr/local/bin)</span>
INSTALL_DIR=<span class="hljs-string">"/usr/local/bin"</span>
<span class="hljs-comment"># Nom du script</span>
SCRIPT_NAME=<span class="hljs-string">"mqtt.sh"</span>
<span class="hljs-comment"># Adresse du broker MQTT</span>
MQTT_BROKER=<span class="hljs-string">"nidus"</span>
<span class="hljs-comment"># Sujets MQTT pour les différentes données</span>
MQTT_TOPIC_CPU=<span class="hljs-string">"benchmark/cpu"</span>
MQTT_TOPIC_RAM=<span class="hljs-string">"benchmark/ram"</span>
MQTT_TOPIC_PROCESSES=<span class="hljs-string">"benchmark/processes"</span>

<span class="hljs-comment"># Vérification si le script est dans le bon dossier d'installation</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$(dirname "$(readlink -f "$0")</span>"</span>)<span class="hljs-string">" != "</span><span class="hljs-variable">$INSTALL_DIR</span><span class="hljs-string">" ]; then
    echo "</span>Erreur : Le script doit être installé dans <span class="hljs-variable">$INSTALL_DIR</span><span class="hljs-string">"
    exit 1
fi

# Vérification et installation des dépendances (mosquitto-clients)
if ! command -v mosquitto_pub &amp;&gt; /dev/null; then
    echo "</span>Installation de mosquitto-clients...<span class="hljs-string">"
    sudo apt-get update
    sudo apt-get install mosquitto-clients
    echo "</span>Installation terminée.<span class="hljs-string">"
fi

# Vérification si le lien symbolique vers init.d existe
if [ ! -e "</span>/etc/init.d/<span class="hljs-variable">$SCRIPT_NAME</span><span class="hljs-string">" ]; then
    echo "</span>Création du lien symbolique dans /etc/init.d...<span class="hljs-string">"
    sudo ln -s "</span><span class="hljs-variable">$INSTALL_DIR</span>/<span class="hljs-variable">$SCRIPT_NAME</span><span class="hljs-string">" "</span>/etc/init.d/<span class="hljs-variable">$SCRIPT_NAME</span><span class="hljs-string">"
    echo "</span>Lien symbolique créé.<span class="hljs-string">"
fi

# Vérification et activation du service init.d
if ! sudo service "</span><span class="hljs-variable">$SCRIPT_NAME</span><span class="hljs-string">" status &amp;&gt; /dev/null; then
    echo "</span>Activation du service...<span class="hljs-string">"
    sudo update-rc.d "</span><span class="hljs-variable">$SCRIPT_NAME</span><span class="hljs-string">" defaults
    echo "</span>Service activé.<span class="hljs-string">"
fi

# Boucle principale pour la collecte et la publication des données
while true; do
    # Collecte des données
    CPU_LOAD=<span class="hljs-variable">$(top -bn1 | grep "Cpu(s)</span>"</span> | awk <span class="hljs-string">'{print $2 + $4}'</span>)
    RAM_LOAD=$(free | awk <span class="hljs-string">'/Mem/{printf("%.2f\n", $3/$2*100)}'</span>)
    PROCESS_COUNT=$(ps aux | wc -l)

    <span class="hljs-comment"># Publication des données sur MQTT</span>
    mosquitto_pub -h <span class="hljs-variable">$MQTT_BROKER</span> -t <span class="hljs-variable">$MQTT_TOPIC_CPU</span> -m <span class="hljs-string">"<span class="hljs-variable">$CPU_LOAD</span>"</span>
    mosquitto_pub -h <span class="hljs-variable">$MQTT_BROKER</span> -t <span class="hljs-variable">$MQTT_TOPIC_RAM</span> -m <span class="hljs-string">"<span class="hljs-variable">$RAM_LOAD</span>"</span>
    mosquitto_pub -h <span class="hljs-variable">$MQTT_BROKER</span> -t <span class="hljs-variable">$MQTT_TOPIC_PROCESSES</span> -m <span class="hljs-string">"<span class="hljs-variable">$PROCESS_COUNT</span>"</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Données publiées sur MQTT"</span>

    sleep 1  <span class="hljs-comment"># Attente d'une seconde</span>
<span class="hljs-keyword">done</span>
</div></code></pre>
<h3 id="1132-description-d%C3%A9taill%C3%A9e-du-script">11.3.2. Description détaillée du script</h3>
<p>Le script commence par vérifier si l'emplacement d'installation est correct, s'assurant qu'il est placé dans le répertoire défini par <strong>INSTALL_DIR</strong>. Ensuite, il vérifie la présence et l'installation des dépendances requises, notamment <strong>mosquitto-clients</strong>, en l'installant si nécessaire.</p>
<p>Une autre vérification importante concerne l'existence d'un lien symbolique vers <strong>/etc/init.d</strong>, qui est nécessaire pour exécuter le script au démarrage de la machine. Si le lien symbolique n'existe pas, le script le crée.</p>
<p>Ensuite, le script s'assure que le service init.d correspondant est activé. Si ce n'est pas le cas, il active le service en utilisant la commande <strong>update-rc.d</strong>.</p>
<p>La section la plus importante du script est la boucle principale, où les données de consommation sont collectées et publiées en continu sur le broker MQTT. Pour chaque itération de la boucle, les taux de charge CPU, de charge RAM et le nombre de processus en cours sont mesurés et enregistrés.</p>
<p>Ces données sont ensuite publiées sur le broker MQTT à l'aide de la commande <strong>mosquitto_pub</strong>. Chaque type de données est publié sur un sujet MQTT spécifique (<strong>$MQTT_TOPIC_CPU</strong>, <strong>$MQTT_TOPIC_RAM</strong>, <strong>$MQTT_TOPIC_PROCESSES</strong>), ce qui permet de les organiser de manière claire.</p>
<p>Le script affiche également un message indiquant que les données ont été publiées sur MQTT, et ensuite attend une seconde avant de reprendre une nouvelle itération de la boucle.</p>
<h3 id="1133-conclusion">11.3.3. Conclusion</h3>
<p>Ce script MQTT élaboré et bien structuré offre un moyen efficace de collecter et de publier les données de consommation sur le broker <strong>MQTT</strong>. Son fonctionnement en boucle continue, combiné à des vérifications et des actions préliminaires, garantit une gestion fiable et optimisée des données, contribuant ainsi à la réussite globale du projet.</p>
<h2 id="114-installation">11.4. Installation</h2>
<pre class="hljs"><code><div>toblerc@LPT-UNIX-USB-CT:~/Documents/ES_2024/banc-de-mesures-de-la-consommation-electrique$ scp ./mqtt.sh tobby@volt:/usr/<span class="hljs-built_in">local</span>/bin/mqtt.sh
mqtt.sh                                                                                                                                                                         100% 2526     2.1MB/s   00:00 
</div></code></pre>
<h2 id="115-utilisation-du-script">11.5. Utilisation du script</h2>
<pre class="hljs"><code><div>tobby@Volt:/usr/<span class="hljs-built_in">local</span>/bin$ sudo ./mqtt.sh
Installation de mosquitto-clients...
[...]
Il est nécessaire de prendre 136 ko dans les archives.
Après cette opération, 568 ko d<span class="hljs-string">'espace disque supplémentaires seront utilisés.
Souhaitez-vous continuer ? [O/n] O
[...]
Installation terminée.
Création du lien symbolique dans /etc/init.d...
Lien symbolique créé.
Activation du service...
Service activé.
</span></div></code></pre>
<h3 id="1151-v%C3%A9rification">11.5.1. Vérification</h3>
<img src="../capture/RPI/Node-Red/MQTT.png" alt="Image" width="100%" style="width:100%;">
<div style="page-break-after: always;"></div>
<h1 id="12-ina219">12. INA219</h1>
<p>Dans ce chapitre, nous explorerons la puce <strong>INA219</strong>, qui joue un rôle essentiel dans la mesure de la consommation. Il est important de noter que nous utilisons deux puces INA219 dans ce projet : l'une pour la mesure proprement dite et l'autre en tant que pièce de rechange en cas de problème. Pour les différencier, nous avons effectué des soudures pour attribuer des adresses I2C spécifiques à chaque puce. L'adresse de la puce de mesure est réglée sur <em>0x40</em>, tandis que l'adresse de la puce de remplacement est réglée sur <em>0x41</em>.</p>
<h3 id="1201-installation-physique">12.0.1. Installation physique</h3>
<p>L'installation physique du <strong>INA219</strong> implique des branchements spécifiques en fonction des scénarios : avec ou sans le dispositif Volt. Voici les détails de chaque configuration :</p>
<h4 id="12011-branchement-sans-volt">12.0.1.1. Branchement SANS VOLT</h4>
<img src="../capture/RPI/INA219/Sans_Volt.jpg" alt="Schéma de branchement sans Volt" width="100%" style="width:100%;">
<h4 id="12012-branchement-avec-volt">12.0.1.2. Branchement AVEC VOLT</h4>
<p>Le branchement avec le dispositif Volt ajoute une complexité supplémentaire. Voici un aperçu détaillé de ce branchement :</p>
<img src="../capture/RPI/INA219/Avec_Volt.jpg" alt="Schéma de branchement avec Volt" width="100%" style="width:100%;">
<img src="../capture/RPI/INA219/Avec_Volt_Detail.jpg" alt="Détail du branchement avec Volt" width="100%" style="width:100%;">
<h3 id="1202-v%C3%A9rification-de-la-pr%C3%A9sence-du-ina219">12.0.2. Vérification de la présence du INA219</h3>
<p>Avant de pouvoir commencer à utiliser le <strong>INA219</strong> pour mesurer la consommation, il est crucial de vérifier la présence de la puce et de s'assurer qu'elle est correctement détectée par le système. Cette étape est essentielle pour garantir des mesures précises et fiables tout au long du projet.</p>
<pre class="hljs"><code><div>tobby@Nidus:~ $ sudo i2cdetect -y 1
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:                         -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
40: 40 -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- -- --         

tobby@Nidus:~ $ sudo i2cdetect -y 1
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:                         -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
40: -- 41 -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- -- --    
</div></code></pre>
<h2 id="121-obtention-des-donn%C3%A9es">12.1. Obtention des données</h2>
<h3 id="1211-test-avec-le-script-python-a-vide">12.1.1. Test avec le script python A vide</h3>
<p>Instalation de la bibliothèque python</p>
<pre class="hljs"><code><div>tobby@Nidus:~ $ sudo pip3 install pi-ina219
Looking <span class="hljs-keyword">in</span> indexes: https://pypi.org/simple, https://www.piwheels.org/simple
Collecting pi-ina219
  Downloading pi_ina219-1.4.1-py2.py3-none-any.whl (10 kB)
Collecting Adafruit-GPIO
  Downloading https://www.piwheels.org/simple/adafruit-gpio/Adafruit_GPIO-1.0.3-py3-none-any.whl (38 kB)
Collecting mock
  Downloading https://www.piwheels.org/simple/mock/mock-5.1.0-py3-none-any.whl (30 kB)
Collecting adafruit-pureio
  Downloading https://www.piwheels.org/simple/adafruit-pureio/Adafruit_PureIO-1.1.11-py3-none-any.whl (10 kB)
Requirement already satisfied: spidev <span class="hljs-keyword">in</span> /usr/lib/python3/dist-packages (from Adafruit-GPIO-&gt;pi-ina219) (3.5)
Installing collected packages: adafruit-pureio, mock, Adafruit-GPIO, pi-ina219
Successfully installed Adafruit-GPIO-1.0.3 adafruit-pureio-1.1.11 mock-5.1.0 pi-ina219-1.4.1
</div></code></pre>
<p>Vérification de la présence de l'INA219</p>
<pre class="hljs"><code><div>tobby@Nidus:~ $ i2cdetect -y 1
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:                         -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
40: 40 -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- -- --      
</div></code></pre>
<p>Création du script python</p>
<pre class="hljs"><code><div>tobby@Nidus:~/Documents $ mkdir py
tobby@Nidus:~/Documents $ <span class="hljs-built_in">cd</span> py
tobby@Nidus:~/Documents/py $ touch my_ina219.py
tobby@Nidus:~/Documents/py $ ls -la
total 8
drwxr-xr-x 2 tobby tobby 4096 22 aoû 10:19 .
drwxr-xr-x 3 tobby tobby 4096 22 aoû 10:18 ..
-rw-r--r-- 1 tobby tobby    0 22 aoû 10:19 my_ina219.py
tobby@Nidus:~/Documents/py $ sudo vi ./my_ina219.py
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-keyword">from</span> ina219 <span class="hljs-keyword">import</span> INA219
<span class="hljs-keyword">from</span> ina219 <span class="hljs-keyword">import</span> DeviceRangeError

SHUNT_OHMS = <span class="hljs-number">0.1</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read</span><span class="hljs-params">()</span>:</span>
    ina = INA219(SHUNT_OHMS)
    ina.configure()

    print(<span class="hljs-string">"Bus Voltage: %.3f V"</span> % ina.voltage())
    <span class="hljs-keyword">try</span>:
        print(<span class="hljs-string">"Bus Current: %.3f mA"</span> % ina.current())
        print(<span class="hljs-string">"Power: %.3f mW"</span> % ina.power())
        print(<span class="hljs-string">"Shunt voltage: %.3f mV"</span> % ina.shunt_voltage())
    <span class="hljs-keyword">except</span> DeviceRangeError <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># Current out of device range with specified shunt resistor</span>
        print(e)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    read()
</div></code></pre>
<p>Execution du script</p>
<pre class="hljs"><code><div>tobby@Nidus:~/Documents/py $ python ./my_ina219.py 
Bus Voltage: 0.888 V
Bus Current: -0.195 mA
Power: 0.000 mW
Shunt voltage: -0.010 mV
</div></code></pre>
<div style="page-break-after: always;"></div>
<h1 id="13-noeud-node-red">13. Noeud Node-Red</h1>
<h2 id="131-ina219">13.1. INA219</h2>
<p>Dans cette section, nous explorons le composant <strong>INA219</strong>, un élément clé de notre projet. L'<strong>INA219</strong> est équipé de deux sorties qui fournissent des valeurs en milliampères et en volts, offrant ainsi des informations cruciales sur la consommation.</p>
<img src="../capture/RPI/Node-Red/INA219.png" alt="Image de l'INA219" width="100%" style="width:100%;">
<p>Pour tirer le meilleur parti de l'INA219, j'ai mis en place une configuration sophistiquée. J'ai configuré des nœuds de fonctions spécifiques pour exclure les valeurs négatives. Ces valeurs négatives sont généralement des erreurs de lecture et doivent être traitées correctement pour garantir des données précises. Ensuite, j'ai élaboré une séquence de traitement pour afficher ces valeurs de manière compréhensible dans un libellé.</p>
<p>En plus de cela, j'ai mis en place un nœud &quot;join&quot; qui joue un rôle crucial. Ce nœud fusionne les deux valeurs obtenues à partir des sorties de l'INA219 en un seul message cohérent. Ce message est ensuite acheminé vers un autre nœud de fonction spécialisé. Ce nœud effectue des calculs complexes pour obtenir les données de consommation en watts. Ces données sont ensuite affichées à la fois dans un libellé, offrant une visualisation claire des résultats, et dans un graphique, permettant une compréhension visuelle de l'évolution de la consommation.</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Récupérer les valeurs de courant (mA) et de tension (V) depuis les propriétés msg.payload</span>
<span class="hljs-keyword">var</span> current_mA = msg.payload.miliamps;
<span class="hljs-keyword">var</span> voltage_V = msg.payload.voltage;

<span class="hljs-comment">// Calculer la puissance en watts (W)</span>
<span class="hljs-keyword">var</span> power_W = (current_mA / <span class="hljs-number">1000</span>) * voltage_V;  <span class="hljs-comment">// Convertir le courant en ampères</span>

<span class="hljs-comment">// Vérifier si la tension est négative</span>
<span class="hljs-keyword">if</span> (voltage_V &lt; <span class="hljs-number">0.5</span>) {
    <span class="hljs-comment">// Si la tension est négative, ne rien faire et retourner le message inchangé</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// Créer un nouvel objet msg avec la puissance en watts comme payload</span>
msg.payload = power_W;
msg.topic = <span class="hljs-string">"Watt"</span>;
<span class="hljs-comment">// Renvoyer le message modifié</span>
<span class="hljs-keyword">return</span> msg;
</div></code></pre>
<h2 id="132-monitoring">13.2. Monitoring</h2>
<img src="../capture/RPI/Node-Red/benchmark.png" alt="Image de Monitoring" width="100%" style="width:100%;">
<p>Dans cette section, nous abordons le <strong>Monitoring</strong>, une étape cruciale de notre projet. Pour cette tâche, j'ai choisi d'utiliser le protocole <strong>MQTT</strong>, qui présente des avantages significatifs en termes de rapidité et de légèreté par rapport au <strong>SSH</strong>.</p>
<p>En commençant par la réception des données via le nœud MQTT, celles-ci sont dirigées vers un nœud de type &quot;gauge&quot; (<em>jauge</em>) qui affiche la valeur en temps réel. Cette représentation visuelle offre une vue instantanée de la consommation, permettant une surveillance efficace.</p>
<div style="page-break-after: always;"></div>
<h2 id="133-dashboard">13.3. Dashboard</h2>
<p>Le <strong>Dashboard</strong>, en tant que centre de contrôle essentiel, rassemble tous les éléments nécessaires pour une visualisation optimale des données générées.</p>
<p>Il met à disposition un ensemble complet de nœuds spécifiques, créant une interface utilisateur intuitive et interactive. Ces nœuds proposent une gamme variée de fonctionnalités pour présenter, ajuster et transmettre les données. Voici quelques exemples des nœuds qui contribuent à cette expérience :</p>
<ul>
<li>
<p><strong>Bouton (<em>Button</em>) :</strong> Permet aux utilisateurs d'interagir et de déclencher des actions de manière directe.</p>
</li>
<li>
<p><strong>Liste déroulante (<em>Dropdown</em>) :</strong> Offre un moyen de sélectionner parmi plusieurs options, permettant un contrôle structuré des paramètres ou des valeurs.</p>
</li>
<li>
<p><strong>Interrupteur (<em>Switch</em>) :</strong> Fournit une transition immédiate entre deux états, souvent utilisé pour activer ou désactiver des fonctionnalités.</p>
</li>
<li>
<p><strong>Curseur (<em>Slider</em>) :</strong> Permet un réglage précis d'une valeur numérique en glissant un curseur. Utile pour ajuster des paramètres continus.</p>
</li>
<li>
<p><strong>Champ numérique (<em>Numeric</em>) :</strong> Fournit une interface pour entrer des valeurs numériques avec précision.</p>
</li>
<li>
<p><strong>Champ de texte (<em>Text input</em>) :</strong> Permet aux utilisateurs d'entrer du texte, généralement pour des commentaires, des descriptions ou des valeurs personnalisées.</p>
</li>
<li>
<p><strong>Sélecteur de date (<em>Date picker</em>) :</strong> Facilite la sélection de dates et d'heures, souvent utilisé pour des enregistrements horodatés.</p>
</li>
<li>
<p><strong>Sélecteur de couleur (<em>Colour picker</em>) :</strong> Permet de choisir précisément une couleur pour des éléments visuels ou des codes couleur.</p>
</li>
<li>
<p><strong>Formulaire (<em>Form</em>) :</strong> Regroupe plusieurs champs de saisie et de contrôle en une entité logique, simplifiant ainsi la collecte de données.</p>
</li>
<li>
<p><strong>Texte (<em>Text</em>) :</strong> Affiche du texte ou des instructions pour guider l'utilisateur dans l'interprétation des données ou l'utilisation de l'interface.</p>
</li>
<li>
<p><strong>Jauge (<em>Gauge</em>) :</strong> Présente graphiquement une valeur numérique, offrant une visualisation rapide d'un état ou d'une mesure.</p>
</li>
<li>
<p><strong>Graphique (<em>Chart</em>) :</strong> Permet la création de divers types de graphiques pour illustrer visuellement les tendances et les relations entre les données.</p>
</li>
<li>
<p><strong>Sortie audio (<em>Audio out</em>) :</strong> Peut être utilisée pour fournir des commentaires auditifs ou des alertes sonores.</p>
</li>
<li>
<p><strong>Notification (<em>Notification</em>) :</strong> Affiche des messages d'information ou d'alerte à l'utilisateur pour des événements spécifiques.</p>
</li>
<li>
<p><strong>Contrôle d'interface utilisateur (<em>UI control</em>) :</strong> Offre des éléments interactifs personnalisables pour répondre aux besoins spécifiques de l'application.</p>
</li>
<li>
<p><strong>Modèle (<em>Template</em>) :</strong> Permet d'intégrer du contenu HTML personnalisé, offrant une flexibilité avancée pour inclure graphiques, widgets et plus encore.</p>
</li>
</ul>
<p>Ces nœuds apportent un ensemble puissant d'outils pour la création d'interfaces visuelles riches, éliminant la nécessité d'une programmation manuelle pour chaque élément. Cela encourage la collaboration efficace entre les développeurs et les utilisateurs non techniques dans la conception d'interfaces utilisateur conviviales et informatives.</p>
<h2 id="134-pdf">13.4. PDF</h2>
<h3 id="1341-base">13.4.1. Base</h3>
<p>Pour generer un PDF, il faut passer un Json dans le payload du message :</p>
<pre class="hljs"><code><div>  {
  <span class="hljs-attr">"_msgid"</span>:<span class="hljs-string">"b63574aa110e9d9b"</span>
  ,<span class="hljs-attr">"payload"</span>:
      {
      <span class="hljs-attr">"content"</span>:
        [
        <span class="hljs-string">"First paragraph"</span>,
        <span class="hljs-string">"Another paragraph, this time a little bit longer to make sure, this line will be divided into at least two lines"</span>
        ]
      },
      <span class="hljs-attr">"topic"</span>:<span class="hljs-string">""</span>
  }
</div></code></pre>
<p>Qui est reçu dans le noeud pdfmake qui le passe en Base64 qui est ensuite reçu dans le noeud write file qui l'écrit dans un fichier PDF.</p>
<img src="../capture/RPI/Node-Red/PDF1.png" alt="Image" width="100%" style="width:100%;">
<h2 id="135-images-de-graphiques-et-de-tableaux">13.5. Images de graphiques et de tableaux</h2>
<p>Une fois que la génération de PDF est maîtrisée, il est temps de valoriser davantage les informations en y ajoutant des images.</p>
<p>En effet, bien que disposer des valeurs à un instant donné soit utile, pouvoir visualiser ces valeurs sous forme de graphique est encore plus puissant. Pour réaliser cela, nous utiliserons le nœud <strong>node-red-contrib-chart-image</strong>, qui nous permettra de générer des graphiques. Ce nœud repose sur le module <strong>Chart.js</strong>, qui permet de créer des graphiques en utilisant du code JavaScript.</p>
<p>En plus du nœud de graphique, nous aurons besoin du nœud <strong>node-red-node-base64</strong>, qui facilitera la conversion d'images en base64 et vice versa. Cette conversion est essentielle pour intégrer les images dans le document PDF.</p>
<p>Cette combinaison de nœuds nous permettra de créer des représentations visuelles attrayantes et informatives des données, offrant ainsi une compréhension plus approfondie et une présentation visuellement engageante.</p>
<div style="page-break-after: always;"></div>
<h1 id="14-stress-test-v10">14. Stress Test V1.0</h1>
<p>J'ai créé une page qui permet de générer un rapport en fonction de la durée et de l'exécution d'un stress test sur Nidus et/ou sur Volt. Voici le flux complet pour la génération du rapport:</p>
<img src="../capture/RPI/Node-Red/RapportPDF/0.png" alt="Flux de Génération du Rapport" width="100%" style="width:100%;">
<p>Pour être honnête, il faut admettre que la lisibilité initiale n'est pas optimale. Par conséquent, j'ai décidé de décomposer le processus en plusieurs étapes afin d'obtenir une meilleure compréhension globale.</p>
<h2 id="141-%C3%A9cran-daccueil">14.1. Écran d'Accueil</h2>
<img src="../capture/RPI/Node-Red/RapportPDF/1.1.png" alt="Écran d'Accueil" width="100%" style="width:50%;">
<p>Au premier abord, vous serez accueilli par un navigateur de fichiers et un formulaire. Ce formulaire vous permet de spécifier la durée du test et de décider si vous souhaitez exécuter un test de stress sur Nidus et/ou sur Volt. Voici le contenu de la page &quot;file&quot; qui contient le formulaire:</p>
<img src="../capture/RPI/Node-Red/RapportPDF/1.png" alt="Contenu de la Page 'file'" width="100%" style="width:100%;">
<p>Après avoir rempli le formulaire:</p>
<img src="../capture/RPI/Node-Red/RapportPDF/2.png" alt="Formulaire Rempli" width="100%" style="width:100%;">
<p>Les nœuds responsables de cette section sont les suivants:</p>
<img src="../capture/RPI/Node-Red/RapportPDF/2.2.png" alt="Nœuds de Gestion" width="100%" style="width:100%;">
<p>Deux éléments se distinguent ici:</p>
<ul>
<li>Un formulaire de &quot;Configuration du Test&quot;</li>
<li>Un bouton &quot;Purge&quot; dont nous discuterons ultérieurement</li>
</ul>
<p>Le formulaire recueille les données saisies par l'utilisateur. Ensuite, il transmet ces données en sortie. Deux fonctions sont connectées à cette sortie. La première fonction ajoute les chemins des fichiers, tels que &quot;chart.png&quot; et &quot;report.pdf&quot;, à un tableau. La seconde fonction gère l'exécution des tests de stress en fonction des entrées de l'utilisateur, et les envoie ensuite à un nœud &quot;exec&quot; qui exécute les commandes sur Nidus et/ou Volt.</p>
<p>La première fonction transmet ensuite les données à une fonction à sorties multiples, ce qui permet d'envoyer différents messages distincts.</p>
<h2 id="142-en-ex%C3%A9cution">14.2. En Exécution</h2>
<img src="../capture/RPI/Node-Red/RapportPDF/3.png" alt="En Exécution" width="100%" style="width:100%;">
<p>Pendant l'exécution, une <strong>barre de progression</strong> est affichée pour montrer l'avancement du test, accompagnée d'une <strong>étiquette</strong> en dessous pour indiquer le pourcentage d'avancement. Cela permet d'obtenir une meilleure visualisation de l'état d'avancement.</p>
<p>En arrière-plan, un certain nombre de tâches se déroulent :</p>
<img src="../capture/RPI/Node-Red/RapportPDF/3.3.png" alt="Tâches en Arrière-plan" width="100%" style="width:100%;">
<p>Pour en donner plus de détails :</p>
<ul>
<li>La première sortie du nœud <strong>Activate</strong> est connectée à un nœud <strong>delay</strong> qui ajuste la durée du test, ainsi qu'à une série d'autres nœuds qui gèrent la barre de progression.</li>
<li>La deuxième sortie du nœud <strong>Activate</strong> est reliée à un nœud MQTT amélioré. Celui-ci permet de souscrire aux <strong>topics</strong> appropriés. Au début du test, il souscrit au topic <code>#/benchmark/#</code>, puis à la fin du test, il reçoit le topic <code>/</code> pour se désinscrire. Cela permet de filtrer uniquement les informations nécessaires et d'éviter d'être submergé par les messages superflus envoyés sur le broker MQTT.</li>
<li>Les six autres sorties du nœud <strong>Activate</strong> ont la même fonction. Elles envoient toutes des messages pour modifier le topic MQTT.</li>
</ul>
<p>Ensuite, ces messages sont acheminés vers un nœud <strong>join</strong>, qui les combine en un tableau de messages. Ce tableau est ensuite transmis à un nœud <strong>function</strong> chargé de traiter les données. Parmi les tâches effectuées par ce nœud figurent la personnalisation des <strong>topics</strong> pour chaque ensemble de données et le calcul de la moyenne des valeurs reçues :</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Définir le sujet du message</span>
msg.topic = <span class="hljs-string">"volt/benchmark/cpu"</span>;

<span class="hljs-comment">// Vérifier si le tableau payload existe et n'est pas vide</span>
<span class="hljs-keyword">if</span> (msg.payload &amp;&amp; <span class="hljs-built_in">Array</span>.isArray(msg.payload) &amp;&amp; msg.payload.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// Convertir les valeurs en chaînes de caractères en nombres entiers</span>
    <span class="hljs-keyword">var</span> numericValues = msg.payload.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(value, <span class="hljs-number">10</span>); <span class="hljs-comment">// 10 indique la base décimale</span>
    }).filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
        <span class="hljs-keyword">return</span> !<span class="hljs-built_in">isNaN</span>(value); <span class="hljs-comment">// Filtrer les valeurs non numériques</span>
    });

    <span class="hljs-comment">// Vérifier si des valeurs numériques ont été trouvées</span>
    <span class="hljs-keyword">if</span> (numericValues.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// Calculer la somme des valeurs numériques dans le tableau</span>
        <span class="hljs-keyword">var</span> sum = numericValues.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">acc, value</span>) </span>{
            <span class="hljs-keyword">return</span> acc + value;
        }, <span class="hljs-number">0</span>);

        <span class="hljs-comment">// Calculer la moyenne en divisant la somme par le nombre d'éléments</span>
        <span class="hljs-keyword">var</span> moyenne = sum / numericValues.length;

        <span class="hljs-comment">// Arrondir la moyenne à deux chiffres après la virgule et au multiple de 0.05 le plus proche</span>
        moyenne = <span class="hljs-built_in">Math</span>.round(moyenne * <span class="hljs-number">20</span>) / <span class="hljs-number">20</span>;

        <span class="hljs-comment">// Ajouter la moyenne au message</span>
        msg.moyenne = moyenne.toFixed(<span class="hljs-number">2</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Si aucune valeur numérique n'a été trouvée, définir la moyenne à 0</span>
        msg.moyenne = <span class="hljs-string">"0.00"</span>;
    }
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Si le tableau est vide ou n'existe pas, définir la moyenne à 0</span>
    msg.moyenne.volt.benchmark.cpu = <span class="hljs-string">"0.00"</span>;
}

<span class="hljs-comment">// Renvoyer le message modifié</span>
<span class="hljs-keyword">return</span> msg;
</div></code></pre>
<p>La partie supérieure permet d'atteindre le même résultat à l'aide de l'INA219. Cependant, puisque je ne peux pas choisir le moment où je veux récupérer les valeurs et qu'elles sont envoyées de manière continue, j'ai utilisé une astuce consistant à détourner les messages de mise à jour de la <strong>barre de progression</strong>. Je les ai synchronisés avec les messages de l'INA219, puis les ai dirigés vers un nœud <strong>join</strong> qui les regroupe. Ensuite, ces messages sont envoyés dans un nœud <strong>switch</strong> qui rejette les messages ne provenant pas de la barre de progression. Cela a pour effet de ne conserver que les messages de l'INA219 pendant le test.</p>
<p>Une fois les ensembles de données collectés, il est temps de les utiliser :</p>
<img src="../capture/RPI/Node-Red/RapportPDF/3.3.3.png" alt="Utilisation des Données" width="100%" style="width:100%;">
<p>Après l'application des fonctions <strong>rename</strong>, deux nœuds <strong>join</strong> sont utilisés pour regrouper les données. L'un regroupe les tableaux de données, tandis que l'autre regroupe les moyennes calculées.</p>
<p>Intéressons-nous d'abord au nœud <strong>Values</strong>, car c'est le premier à être utilisé. Il permet de créer un tableau de données qui est ensuite transmis à une série de nœuds de fonctions. Ces nœuds de fonctions traitent les données et les formatent pour créer des <strong>graphiques linéaires</strong> sous forme d'images PNG :</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Données reçues du flux précédent</span>
<span class="hljs-keyword">var</span> rawData = msg.payload;
<span class="hljs-keyword">var</span> delayInSeconds = msg.delay / <span class="hljs-number">1000</span>; <span class="hljs-comment">// Conversion en secondes</span>

<span class="hljs-comment">// Extraction des données nécessaires</span>
<span class="hljs-keyword">var</span> voltWatt = rawData;
<span class="hljs-comment">// Création du graphique</span>
<span class="hljs-keyword">var</span> chartData = {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'line'</span>,  <span class="hljs-comment">// Changement du type de graphique en "line"</span>
    <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">title</span>: {
            <span class="hljs-attr">display</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">text</span>: <span class="hljs-string">'Comparaison des performances'</span>
        },
        <span class="hljs-attr">legend</span>: {
            <span class="hljs-attr">display</span>: <span class="hljs-literal">true</span>
        },
        <span class="hljs-attr">chartArea</span>: {
            <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#d3d7dd'</span>
        },
        <span class="hljs-attr">plugins</span>: {
            <span class="hljs-attr">datalabels</span>: {
                <span class="hljs-attr">display</span>: <span class="hljs-literal">false</span>  <span class="hljs-comment">// Désactiver l'affichage des étiquettes de données</span>
            }
        }
    },
    <span class="hljs-attr">data</span>: {
        <span class="hljs-attr">labels</span>: <span class="hljs-built_in">Array</span>.from({ <span class="hljs-attr">length</span>: voltWatt.length }, (_, i) =&gt; (i * delayInSeconds).toFixed(<span class="hljs-number">1</span>)),  <span class="hljs-comment">// Temps en secondes</span>
        <span class="hljs-attr">datasets</span>: [
            
            {
                <span class="hljs-attr">label</span>: <span class="hljs-string">"Volt Watt"</span>,
                <span class="hljs-attr">borderColor</span>: <span class="hljs-string">'rgba(0, 255, 255, 1)'</span>,
                <span class="hljs-attr">fill</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">data</span>: voltWatt,
                <span class="hljs-attr">pointRadius</span>: <span class="hljs-number">0</span>,
            },
        ]
    }
};

msg.payload = chartData;

<span class="hljs-keyword">return</span> msg;
</div></code></pre>
<p>L'exemple ci-dessus est volontairement plus simple, car il ne contient qu'un seul ensemble de données, à savoir les watts de Volt.<br>
À la sortie de cette fonction, un nœud utilise ce qui a été créé pour générer un <strong>tampon PNG</strong>. Ce tampon est ensuite transmis à un nœud <strong>write file</strong> qui écrit le fichier dans le dossier spécifié par le nœud <strong>Ajoute le nom du fichier</strong>, situé après le formulaire. Simultanément, le nœud envoie également le tampon à un nœud <strong>join</strong> qui attend que tous les graphiques soient créés pour qu'ils puissent être réutilisés.</p>
<p>Une fois que le signal indiquant que les fichiers ont été créés est reçu, le nœud <strong>join</strong> appelé <strong>Moyenne</strong> peut transmettre ses données. Ces données sont réorganisées par un nœud <strong>change</strong>, puis envoyées à plusieurs autres nœuds pour récupérer les images en base64 des graphiques. Ces images sont envoyées en même temps que les moyennes à la fonction <strong>Créer le contenu du fichier</strong> :</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Cette section crée un objet payload qui sera utilisé pour générer un rapport PDF.</span>

msg.payload = {
    <span class="hljs-comment">// Header du rapport PDF</span>
    <span class="hljs-attr">header</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">currentPage, pageCount, pageSize</span>) </span>{
        <span class="hljs-keyword">return</span> [
            {
                <span class="hljs-attr">text</span>: <span class="hljs-string">"Tobler Cyril"</span>, <span class="hljs-comment">// Nom de l'auteur du rapport</span>
                <span class="hljs-attr">alignment</span>: <span class="hljs-string">"left"</span>, <span class="hljs-comment">// Alignement du texte à gauche</span>
                <span class="hljs-attr">fontSize</span>: <span class="hljs-number">10</span>, <span class="hljs-comment">// Taille de la police 10</span>
                <span class="hljs-attr">margin</span>: [<span class="hljs-number">15</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>] <span class="hljs-comment">// Marge (haut, droite, bas, gauche)</span>
            },
            {
                <span class="hljs-attr">text</span>: <span class="hljs-string">"Nom du projet : Confuse T-Rex"</span>, <span class="hljs-comment">// Nom du projet</span>
                <span class="hljs-attr">alignment</span>: <span class="hljs-string">"center"</span>, <span class="hljs-comment">// Alignement du texte au centre</span>
                <span class="hljs-attr">fontSize</span>: <span class="hljs-number">10</span>, <span class="hljs-comment">// Taille de la police 10</span>
                <span class="hljs-attr">margin</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>] <span class="hljs-comment">// Pas de marge</span>
            }
        ];
    },
    <span class="hljs-comment">// Footer du rapport PDF</span>
    <span class="hljs-attr">footer</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">currentPage, pageCount</span>) </span>{
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">columns</span>: [
                {
                    <span class="hljs-attr">text</span>: currentPage.toString() + <span class="hljs-string">" / "</span> + pageCount, <span class="hljs-comment">// Numéro de page actuel / Nombre total de pages</span>
                    <span class="hljs-attr">alignment</span>: <span class="hljs-string">"left"</span>,
                    <span class="hljs-attr">fontSize</span>: <span class="hljs-number">10</span>,
                    <span class="hljs-attr">margin</span>: [<span class="hljs-number">15</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>]
                },
                {
                    <span class="hljs-attr">text</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleDateString(<span class="hljs-string">"fr-FR"</span>), <span class="hljs-comment">// Date actuelle au format français</span>
                    <span class="hljs-attr">alignment</span>: <span class="hljs-string">"right"</span>,
                    <span class="hljs-attr">fontSize</span>: <span class="hljs-number">10</span>,
                    <span class="hljs-attr">margin</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">15</span>, <span class="hljs-number">10</span>]
                }
            ],
            <span class="hljs-attr">margin</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>] <span class="hljs-comment">// Marge du footer</span>
        };
    },
    <span class="hljs-comment">// Contenu du rapport PDF</span>
    <span class="hljs-attr">content</span>: [
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"Rapport d'utilisation"</span>, <span class="hljs-comment">// Titre du rapport</span>
            <span class="hljs-attr">style</span>: <span class="hljs-string">"header"</span>, <span class="hljs-comment">// Style de texte "header" défini ci-dessous</span>
            <span class="hljs-attr">margin</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>] <span class="hljs-comment">// Marge du titre</span>
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"Les valeurs sont des moyennes sur les "</span> + <span class="hljs-built_in">Math</span>.floor(msg.delay / (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span>)) + <span class="hljs-string">" dernières minutes"</span> <span class="hljs-comment">// Informations sur les valeurs</span>
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"Nidus :"</span>,
            <span class="hljs-attr">style</span>: <span class="hljs-string">"header2"</span>
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"CPU :                 "</span> + msg.payload.moyenne[<span class="hljs-string">"nidus/benchmark/cpu"</span>]
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"RAM :                 "</span> + msg.payload.moyenne[<span class="hljs-string">"nidus/benchmark/ram"</span>]
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"Nombre de processus : "</span> + msg.payload.moyenne[<span class="hljs-string">"nidus/benchmark/processes"</span>]
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"Température CPU :     "</span> + msg.payload.moyenne[<span class="hljs-string">"nidus/benchmark/temp"</span>]
        },
        {
            <span class="hljs-attr">image</span>: <span class="hljs-string">'nidusImage'</span>,
            <span class="hljs-attr">width</span>: <span class="hljs-number">500</span>,
            <span class="hljs-attr">pageBreak</span>: <span class="hljs-string">'after'</span>,
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"Volt"</span>,
            <span class="hljs-attr">style</span>: <span class="hljs-string">"header2"</span>
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"CPU :                 "</span> + msg.payload.moyenne[<span class="hljs-string">"volt/benchmark/cpu"</span>]
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"RAM :                 "</span> + msg.payload.moyenne[<span class="hljs-string">"volt/benchmark/ram"</span>]
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"Nombre de processus : "</span> + msg.payload.moyenne[<span class="hljs-string">"volt/benchmark/processes"</span>]
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"Température CPU :     "</span> + msg.payload.moyenne[<span class="hljs-string">"volt/benchmark/temp"</span>]
        }, 
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"MilliWatt :           "</span> + msg.payload.moyenne[<span class="hljs-string">"volt/benchmark/watt"</span>]
        },
        {
            <span class="hljs-attr">image</span>: <span class="hljs-string">'voltImage'</span>,
            <span class="hljs-attr">width</span>: <span class="hljs-number">500</span>
        }, 
        {
            <span class="hljs-attr">image</span>: <span class="hljs-string">'wattImage'</span>,
            <span class="hljs-attr">width</span>: <span class="hljs-number">500</span>
        },
    ],
     <span class="hljs-comment">// Images à inclure dans le rapport</span>
    <span class="hljs-attr">images</span>: {
        <span class="hljs-attr">voltImage</span>: <span class="hljs-string">'data:image/png;base64,'</span> + msg.payload.voltGraph.toString(<span class="hljs-string">'base64'</span>), <span class="hljs-comment">// Image Volt au format base64</span>
        <span class="hljs-attr">wattImage</span>: <span class="hljs-string">'data:image/png;base64,'</span> + msg.payload.wattGraph.toString(<span class="hljs-string">'base64'</span>),  <span class="hljs-comment">// Image Watt de Volt au format base64</span>
        <span class="hljs-attr">nidusImage</span>: <span class="hljs-string">'data:image/png;base64,'</span> + msg.payload.nidusGraph.toString(<span class="hljs-string">'base64'</span>),  <span class="hljs-comment">// Image Nidus au format base64</span>
    },
    <span class="hljs-comment">// Styles de texte personnalisés</span>
    <span class="hljs-attr">styles</span>: {
        <span class="hljs-attr">header</span>: {
            <span class="hljs-attr">fontSize</span>: <span class="hljs-number">22</span>, <span class="hljs-comment">// Taille de la police 22</span>
            <span class="hljs-attr">bold</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Texte en gras</span>
            <span class="hljs-attr">margin</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">30</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>] <span class="hljs-comment">// Marge du titre</span>
        },
        <span class="hljs-attr">header2</span>: {
            <span class="hljs-attr">fontSize</span>: <span class="hljs-number">18</span>, <span class="hljs-comment">// Taille de la police 18</span>
            <span class="hljs-attr">bold</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Texte en gras</span>
            <span class="hljs-attr">margin</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">20</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>] <span class="hljs-comment">// Marge des sous-titres</span>
        }
    }
};

<span class="hljs-comment">// Renvoie le message avec le payload généré</span>
<span class="hljs-keyword">return</span> msg;
</div></code></pre>
<p>Cette fonction va créer, de manière similaire aux graphiques, une structure utilisée par PDFMake pour générer un fichier PDF. Cette structure est ensuite transmise à un nœud <strong>pdfmake</strong>, qui la convertit en base64 et l'envoie à un nœud <strong>write file</strong>. Ce dernier écrit le fichier PDF dans le dossier spécifié par le nœud <strong>Ajoute le nom du fichier</strong>, situé après le formulaire.</p>
<p>Le nœud final permet de mettre à jour le modèle HTML qui répertorie les fichiers PDF et PNG dans le dossier défini par le nœud <strong>Ajoute le nom du fichier</strong>. Ce modèle HTML permet de les télécharger en un seul clic.</p>
<h2 id="143-r%C3%A9sultat">14.3. Résultat</h2>
<img src="../capture/RPI/Node-Red/RapportPDF/4.png" alt="Alt text" width="100%" style="width:100%;">
<p>Pour obtenir les résultats, il suffit de cliquer sur le nom du fichier, qui sera automatiquement téléchargé. Ce processus est géré par ces nœuds :</p>
<img src="../capture/RPI/Node-Red/RapportPDF/4.4.png" alt="Alt text" width="100%" style="width:100%;">
<p>La partie supérieure gère l'affichage des fichiers dans un modèle et ajoute aux noms de fichier des requêtes GET qui permettent de télécharger les fichiers en un seul clic. La partie inférieure gère la réception des requêtes GET et envoie le fichier demandé à un nœud <strong>read file</strong>, qui le lit et l'envoie ensuite à un nœud <strong>http response</strong>. Ce dernier envoie le fichier au client ayant effectué la requête.</p>
<img src="../capture/RPI/Node-Red/RapportPDF/5.png" alt="Alt text" width="100%" style="width:100%;">
<h2 id="144-purge">14.4. Purge</h2>
<p>Au cours de mes tests, j'ai réalisé qu'un problème survient lorsque l'on génère un certain nombre de rapports, le dossier devient rapidement surchargé. Par conséquent, j'ai décidé de mettre en place un bouton permettant de purger le dossier de tous les fichiers .pdf et .png qui s'y trouvent. Cependant, pour éviter toute suppression accidentelle de fichiers importants, j'ai mis en place un système de confirmation demandant à l'utilisateur s'il est sûr de vouloir supprimer les fichiers.</p>
<img src="../capture/RPI/Node-Red/RapportPDF/6.png" alt="Alt text" width="100%" style="width:100%;">
<img src="../capture/RPI/Node-Red/RapportPDF/7.png" alt="Alt text" width="50%" style="width:50%;">
<p>Voici les nœuds qui gèrent cette partie :</p>
<img src="../capture/RPI/Node-Red/RapportPDF/6.6.png" alt="Alt text" width="100%" style="width:100%;">
<p>Ce que l'on peut observer, c'est qu'après avoir appuyé sur le bouton de purge, un message est envoyé dans un nœud <code>show dialog</code> qui affiche une fenêtre de confirmation. Si l'utilisateur appuie sur le bouton &quot;Oui&quot;, un message est transmis à un nœud de fonction qui vérifie le contenu du message et redemande une confirmation s'il est à nouveau validé. À ce stade, deux flux sont créés :</p>
<ul>
<li>Le premier effectue la purge totale de tous les fichiers dans <code>/home/NodeRed/</code>.</li>
<li>Le second commence par un délai de quelques secondes avant de recréer les dossiers de structuration.</li>
</ul>
<div style="page-break-after: always;"></div>
<h1 id="15-gatling-test-v20">15. Gatling Test V2.0</h1>
<h2 id="151-but">15.1. But</h2>
<p>L'objectif de cette étape est d'intégrer Gatling aux tests de Node-Red, offrant ainsi la possibilité de réaliser à la fois des tests de charge et des tests de stress sur la même infrastructure.</p>
<h2 id="152-%C3%A9tapes-%C3%A0-atteindre">15.2. Étapes à Atteindre</h2>
<ol>
<li>
<p><strong>Exécution d'un Test Préétabli sur Gatling depuis Node-Red</strong> : La première étape consiste à configurer et à exécuter un test préétabli à l'aide de Gatling directement depuis l'environnement Node-Red. Cela permettra de lancer les scénarios de test sur l'application ou le système cible.</p>
</li>
<li>
<p><strong>Récupération des Résultats de Gatling et Création de Graphiques pour l'Incorporation au PDF</strong> : Une fois le test Gatling terminé, nous devrons récupérer les résultats générés par Gatling. Ces résultats seront ensuite transformés en graphiques informatifs pour être intégrés dans le rapport PDF. Cette étape vise à rendre les données de performance facilement compréhensibles.</p>
</li>
<li>
<p><strong>Définition de la Durée du Test Gatling depuis Node-Red</strong> : Pour chaque test Gatling, il sera nécessaire de définir la durée de l'exécution du test directement depuis Node-Red. Cela permettra de personnaliser la durée des tests en fonction des exigences du projet.</p>
</li>
</ol>
<p>Cette intégration de Gatling aux tests Node-Red offre un moyen puissant d'évaluer les performances de l'infrastructure tout en maintenant un contrôle complet sur les scénarios de test et les paramètres de durée.</p>
<h2 id="153-ex%C3%A9cution-dun-test-pr%C3%A9%C3%A9tabli-sur-gatling-depuis-node-red">15.3. Exécution d'un Test Préétabli sur Gatling depuis Node-Red</h2>
<p>L'exécution d'un test préétabli sur Gatling depuis Node-Red revêt une importance cruciale pour la suite du projet. Cela permettra de lancer les scénarios de test sur l'application ou le système cible. Pour réaliser cette étape, nous allons utiliser le nœud <strong>exec</strong> de Node-Red, qui nous permet d'exécuter des commandes sur le système d'exploitation. Ce nœud sera utilisé pour lancer les commandes Gatling nécessaires afin de lancer les tests.</p>
<p>Je lui transmets la commande suivante en entrée :</p>
<pre class="hljs"><code><div>tobby@Nidus:~ $ /home/tobby/.gatling/gatling-charts-highcharts-bundle-3.9.5/bin/gatling.sh -s CuriusTRex -bm --run-mode <span class="hljs-built_in">local</span> -erjo <span class="hljs-string">" -Dusers=5 -Dramp=5"</span>
</div></code></pre>
<img src="../capture/RPI/Node-Red/RapportPDF/8.png" alt="Alt text" width="100%" style="width:100%;">
<img src="../capture/RPI/Node-Red/RapportPDF/8.8.png" alt="Alt text" width="100%" style="width:100%;">
<h2 id="154-envoi-de-commande-avec-une-dur%C3%A9e">15.4. Envoi de Commande avec une Durée</h2>
<p>L'une des premières étapes essentielles est de pouvoir définir une durée pour le test. Pour accomplir cette tâche, j'ai employé un nœud <strong>function</strong> qui permet de spécifier la durée du test en fonction de la valeur saisie par l'utilisateur. Cette valeur est ensuite transmise à un nœud <strong>exec</strong> qui se charge d'exécuter la commande Gatling nécessaire. Voici le code de la fonction :</p>
<pre class="hljs"><code><div>msg.original = msg.payload;
<span class="hljs-keyword">if</span> (msg.topic !== <span class="hljs-string">"inject"</span> &amp;&amp; msg.payload.time_gatling !== <span class="hljs-literal">undefined</span> &amp;&amp; msg.payload.user_gatling !== <span class="hljs-literal">undefined</span>) {
    <span class="hljs-comment">// Crée la commande en utilisant les valeurs spécifiées</span>
    msg.payload.time = msg.payload.time_gatling * <span class="hljs-number">60</span>;
    msg.payload = <span class="hljs-string">`/home/tobby/.gatling/gatling-charts-highcharts-bundle-3.9.5/bin/gatling.sh -s CuriusTRex -bm --run-mode local -erjo "-Dusers=<span class="hljs-subst">${msg.payload.user_gatling}</span> -Dramp=<span class="hljs-subst">${msg.payload.time_gatling}</span>"`</span>;
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Utilise la commande d'origine car il ne s'agit pas d'un noeud inject ou les valeurs ne sont pas fournies</span>
    <span class="hljs-comment">// Par défaut, utilisez la commande actuelle</span>
    msg.payload = <span class="hljs-string">"/home/tobby/.gatling/gatling-charts-highcharts-bundle-3.9.5/bin/gatling.sh -s CuriusTRex -bm --run-mode local -erjo \" -Dusers=5 -Dramp=5\""</span>;
}

<span class="hljs-comment">// Renvoie le message modifié</span>
<span class="hljs-keyword">return</span> msg;
</div></code></pre>
<h2 id="155-r%C3%A9cup%C3%A9ration-des-informations">15.5. Récupération des Informations</h2>
<p>Pour obtenir les informations d'un rapport Gatling, j'ai dû entreprendre une rétro-ingénierie significative. En effet, Gatling ne propose pas de mécanisme direct pour extraire des informations depuis la ligne de commande. Il est nécessaire de collecter les données directement à partir des fichiers générés par Gatling. Voici un exemple de fichier généré par Gatling :</p>
<pre class="hljs"><code><div>RUN	CuriusTRex_Bash	curiustrex-bash	1693898386165	 	3.9.5
USER	CuriusTRex	START	1693898386953
REQUEST		request_0	1693898386949	1693898386985	OK	 
REQUEST		request_1	1693898387009	1693898387014	OK	 
USER	CuriusTRex	START	1693898387108
REQUEST		request_0	1693898387107	1693898387128	OK	 
REQUEST		request_1	1693898387132	1693898387136	OK	 
REQUEST		styles.css	1693898387162	1693898387167	OK	 
REQUEST		styles.css	1693898387162	1693898387167	OK	 
REQUEST		request_2	1693898387184	1693898387189	OK	 
REQUEST		request_2	1693898387184	1693898387189	OK	 
REQUEST		styles.css	1693898387211	1693898387222	OK	 
REQUEST		Home.jpg	1693898387212	1693898387228	OK	 
REQUEST		styles.css	1693898387223	1693898387233	OK	 
REQUEST		Données.jpg	1693898387213	1693898387234	OK	 
REQUEST		Home.jpg	1693898387224	1693898387239	OK	 
REQUEST		Test_Complet.jpg	1693898387215	1693898387241	OK	
</div></code></pre>
<p>On peut donc voir qu'il y a <strong>beaucoup d'information à traiter dans ce cas particulier</strong>, le test dure 30 secondes avec 5 utilisateurs, et le fichier <code>simulation.log</code> fait <strong>3114 lignes</strong>.</p>
<p>Étant donné que les informations sont sauvegardées à chaque fois dans un fichier différent, j'ai mis en place une fonction dans un nœud qui me permet de récupérer le nom du dossier dans lequel le rapport et les logs sont sauvegardés.</p>
<p>Ensuite, j'en fais un tableau de chemins de fichiers :</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Fonction pour extraire le chemin après "file://"</span>
<span class="hljs-keyword">var</span> inputPayload = msg.payload;

<span class="hljs-comment">// Recherche de l'index de "file://"</span>
<span class="hljs-keyword">var</span> fileIndex = inputPayload.indexOf(<span class="hljs-string">"file://"</span>);

<span class="hljs-comment">// Si "file://" est trouvé, extrayez le chemin après</span>
<span class="hljs-keyword">if</span> (fileIndex !== <span class="hljs-number">-1</span>) {
    <span class="hljs-comment">// Extraire le chemin après "file://"</span>
    <span class="hljs-keyword">var</span> filePath = inputPayload.substring(fileIndex + <span class="hljs-number">7</span>); <span class="hljs-comment">// +7 pour sauter "file://"</span>

    <span class="hljs-comment">// Supprimer le fichier index.html du chemin, s'il est présent</span>
        filePath = filePath.substring(<span class="hljs-number">0</span>, filePath.length - <span class="hljs-number">12</span>); <span class="hljs-comment">// -11 pour enlever "/index.html"</span>

    <span class="hljs-comment">// Mettre le chemin extrait dans le message de sortie</span>
    msg.payload = filePath;

    <span class="hljs-comment">// Tableau de noms de fichiers .json</span>
    <span class="hljs-keyword">var</span> jsonFilesList = [
        <span class="hljs-string">"assertions.json"</span>,
        <span class="hljs-string">"global_stats.json"</span>,
        <span class="hljs-string">"stats.json"</span>
    ];

    <span class="hljs-comment">// Créer un tableau de clé-valeurs pour les fichiers .json</span>
    <span class="hljs-keyword">var</span> jsonFilesKeyValue = {};

    <span class="hljs-comment">// Parcourir la liste des noms de fichiers et construire les chemins complets</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; jsonFilesList.length; i++) {
        <span class="hljs-keyword">var</span> jsonFileName = jsonFilesList[i];
        <span class="hljs-keyword">var</span> jsonFilePath = filePath + <span class="hljs-string">'/js/'</span> + jsonFileName;
        jsonFilesKeyValue[jsonFileName] = jsonFilePath;
    }

    <span class="hljs-comment">// Ajouter le tableau de clé-valeurs au message</span>
    msg.jsonFiles = jsonFilesKeyValue;

    <span class="hljs-comment">// Renvoyer le message modifié</span>
    <span class="hljs-keyword">return</span> msg;
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Aucun "file://" trouvé, renvoyer le message d'origine</span>
    <span class="hljs-keyword">return</span> msg;
}
</div></code></pre>
<p>Tout cela se fait à la sortie du nœud exec, lequel renvoie les informations suivantes :</p>
<pre class="hljs"><code><div>[...]
================================================================================
2023-09-05 11:05:03                                          29s elapsed
---- Requests ------------------------------------------------------------------
&gt; Global                                                   (OK=2816   KO=0     )
&gt; request_0                                                (OK=150    KO=0     )
&gt; request_1                                                (OK=150    KO=0     )
&gt; styles.css                                               (OK=450    KO=0     )
&gt; request_2                                                (OK=150    KO=0     )
&gt; Home.jpg                                                 (OK=300    KO=0     )
&gt; Données.jpg                                              (OK=300    KO=0     )
&gt; Test.jpg                                                 (OK=300    KO=0     )
&gt; Test_Complet.jpg                                         (OK=300    KO=0     )
&gt; request_3                                                (OK=150    KO=0     )
&gt; request_5                                                (OK=150    KO=0     )
&gt; request_4                                                (OK=150    KO=0     )
&gt; request_6                                                (OK=116    KO=0     )
&gt; request_7                                                (OK=150    KO=0     )

---- CuriusTRex ----------------------------------------------------------------
[<span class="hljs-comment">##########################################################################]100%</span>
          waiting: 0      / active: 0      / <span class="hljs-keyword">done</span>: 150   
================================================================================

Simulation CuriusTRex_Bash completed <span class="hljs-keyword">in</span> 29 seconds
Parsing <span class="hljs-built_in">log</span> file(s)...
Parsing <span class="hljs-built_in">log</span> file(s) <span class="hljs-keyword">done</span>
Generating reports...

================================================================================
---- Global Information --------------------------------------------------------
&gt; request count                                       2816 (OK=2816   KO=0     )
[...]
---- Response Time Distribution ------------------------------------------------
&gt; t &lt; 800 ms                                          2816 (100%)
&gt; 800 ms &lt;= t &lt; 1200 ms                                  0 (  0%)
&gt; t &gt;= 1200 ms                                           0 (  0%)
&gt; failed                                                 0 (  0%)
================================================================================

Reports generated <span class="hljs-keyword">in</span> 0s.
Please open the following file: file:///home/toblerc/T%C3%A9l%C3%A9chargements/gatling-charts-highcharts-bundle-3.9.5/results/curiustrex-bash-20230905090433239/index.html
</div></code></pre>
<h2 id="156-traitement-des-donn%C3%A9es">15.6. Traitement des données</h2>
<p>Une fois les chemins des fichiers définis, je lis les fichiers JSON et les transmets à un nœud <strong>JSON</strong> chargé de les traiter et de les renvoyer dans un format exploitable par Node-Red.</p>
<p>En sortie, j'assemble les quatre fichiers en un seul message que j'envoie ensuite aux fonctions de création de graphiques.</p>
<h3 id="1561-cr%C3%A9ation-des-graphiques">15.6.1. Création des graphiques</h3>
<p>Je crée deux graphiques, l'un utilisant le pourcentage de réussite et d'échec pour générer un bar chart :</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Données reçues du flux précédent</span>
<span class="hljs-keyword">var</span> rawData = msg.payload.gatling.Global;  <span class="hljs-comment">// Utilisez les données de msg.payload.gatling.Global</span>
msg.topic = <span class="hljs-string">"VoltBarChart"</span>; <span class="hljs-comment">// Définir le sujet du message</span>

<span class="hljs-comment">// Extraction des données nécessaires</span>
<span class="hljs-keyword">var</span> groupData = [
    rawData.group1,
    rawData.group2,
    rawData.group3,
    rawData.group4
];

<span class="hljs-keyword">var</span> labels = [];
<span class="hljs-keyword">var</span> percentages = [];

<span class="hljs-comment">// Parcourir les données des groupes et extraire les informations</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt;= groupData.length; i++) {
    <span class="hljs-keyword">var</span> groupName = <span class="hljs-string">"group"</span> + i;
    labels.push(rawData[groupName].htmlName);
    percentages.push(rawData[groupName].percentage);
}

<span class="hljs-comment">// Création du graphique</span>
<span class="hljs-keyword">var</span> chartData = {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'bar'</span>,  <span class="hljs-comment">// Utiliser un graphique de type "bar"</span>
    <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">title</span>: {
            <span class="hljs-attr">display</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">text</span>: <span class="hljs-string">'Répartition des performances par groupe'</span> <span class="hljs-comment">// Titre du graphique</span>
        },
        <span class="hljs-attr">chartArea</span>: {
            <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#d3d7dd'</span> <span class="hljs-comment">// Couleur de fond du graphique</span>
        },
        <span class="hljs-attr">scales</span>: {
            <span class="hljs-attr">x</span>: {
                <span class="hljs-attr">beginAtZero</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">title</span>: {
                    <span class="hljs-attr">display</span>: <span class="hljs-literal">true</span>,
                    <span class="hljs-attr">text</span>: <span class="hljs-string">'Groupes'</span> <span class="hljs-comment">// Titre de l'axe des X</span>
                }
            },
            <span class="hljs-attr">y</span>: {
                <span class="hljs-attr">beginAtZero</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">title</span>: {
                    <span class="hljs-attr">display</span>: <span class="hljs-literal">true</span>,
                    <span class="hljs-attr">text</span>: <span class="hljs-string">'Pourcentage'</span> <span class="hljs-comment">// Titre de l'axe des Y</span>
                }
            }
        },
        <span class="hljs-attr">plugins</span>: {
            <span class="hljs-attr">datalabels</span>: {
                <span class="hljs-attr">anchor</span>: <span class="hljs-string">'end'</span>,
                <span class="hljs-attr">align</span>: <span class="hljs-string">'top'</span>,
                <span class="hljs-attr">formatter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
                    <span class="hljs-keyword">return</span> value + <span class="hljs-string">'%'</span>;  <span class="hljs-comment">// Ajouter le symbole de pourcentage à l'étiquette</span>
                }
            }
        }
    },
    <span class="hljs-attr">data</span>: {
        <span class="hljs-attr">labels</span>: labels,
        <span class="hljs-attr">datasets</span>: [
            {
                <span class="hljs-attr">label</span>: <span class="hljs-string">"Pourcentage"</span>, <span class="hljs-comment">// Légende de l'ensemble de données</span>
                <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'rgba(0, 128, 255, 0.7)'</span>,  <span class="hljs-comment">// Couleur du remplissage des barres</span>
                <span class="hljs-attr">data</span>: percentages
            }
        ]
    }
};

msg.payload = chartData; <span class="hljs-comment">// Attribuer les données du graphique au message</span>

<span class="hljs-keyword">return</span> msg; <span class="hljs-comment">// Renvoyer le message</span>
</div></code></pre>
<p>Le deuxième calcule le temps de réponse de chaque requête afin de créer un graphique linéaire :</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Assurez-vous que msg.payload.gatling.Log est un tableau</span>
<span class="hljs-keyword">var</span> logEntries = <span class="hljs-built_in">Array</span>.isArray(msg.payload.gatling.Log) ? msg.payload.gatling.Log : [];

<span class="hljs-comment">// Création du graphique</span>
<span class="hljs-keyword">var</span> chartData = {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'line'</span>, <span class="hljs-comment">// Utilisez un graphique de type "line"</span>
    <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">title</span>: {
            <span class="hljs-attr">display</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">text</span>: <span class="hljs-string">'Comparaison des performances'</span> <span class="hljs-comment">// Titre du graphique</span>
        },
        <span class="hljs-attr">legend</span>: {
            <span class="hljs-attr">display</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// Affichez la légende du graphique</span>
        },
        <span class="hljs-attr">chartArea</span>: {
            <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#d3d7dd'</span> <span class="hljs-comment">// Couleur de fond du graphique</span>
        },
        <span class="hljs-attr">plugins</span>: {
            <span class="hljs-attr">datalabels</span>: {
                <span class="hljs-attr">display</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// Désactivez l'affichage des étiquettes de données</span>
            }
        }
    },
    <span class="hljs-attr">data</span>: {
        <span class="hljs-attr">labels</span>: logEntries.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
            <span class="hljs-keyword">if</span> (entry.type === <span class="hljs-string">'RUN'</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">'Début de la Simulation'</span>; <span class="hljs-comment">// Label pour les opérations de type "RUN"</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (entry.type === <span class="hljs-string">'REQUEST'</span>) {
                <span class="hljs-comment">// Calcul de la différence en millisecondes entre le début de la simulation et le début de la requête</span>
                <span class="hljs-keyword">var</span> simulationStart = logEntries.find(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{
                    <span class="hljs-keyword">return</span> item.type === <span class="hljs-string">'RUN'</span>;
                });
                <span class="hljs-keyword">if</span> (simulationStart) {
                    <span class="hljs-keyword">var</span> startTime = simulationStart.start;
                    <span class="hljs-keyword">var</span> requestTime = entry.start;
                    <span class="hljs-keyword">var</span> timeDiff = requestTime - startTime;
                    <span class="hljs-keyword">return</span> (timeDiff / <span class="hljs-number">1000</span>).toFixed(<span class="hljs-number">0</span>) + <span class="hljs-string">' s'</span>; <span class="hljs-comment">// Temps en secondes</span>
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-string">'N/A'</span>; <span class="hljs-comment">// Si aucune opération de type "RUN" n'est trouvée</span>
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>; <span class="hljs-comment">// Autres types d'opérations (USER, etc.) sans label</span>
            }
        }),
        <span class="hljs-attr">datasets</span>: [
            {
                <span class="hljs-attr">label</span>: <span class="hljs-string">"Temps de Réponse"</span>, <span class="hljs-comment">// Légende de l'ensemble de données</span>
                <span class="hljs-attr">borderColor</span>: <span class="hljs-string">'rgba(0, 128, 255, 1)'</span>, <span class="hljs-comment">// Couleur de la ligne du graphique</span>
                <span class="hljs-attr">fill</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// Désactivez le remplissage sous la ligne</span>
                <span class="hljs-attr">data</span>: logEntries.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
                    <span class="hljs-keyword">if</span> (entry.type === <span class="hljs-string">'REQUEST'</span>) {
                        <span class="hljs-comment">// Calcul de la différence en millisecondes entre le début et la fin de la requête</span>
                        <span class="hljs-keyword">var</span> requestStart = entry.start;
                        <span class="hljs-keyword">var</span> requestEnd = entry.end;
                        <span class="hljs-keyword">var</span> requestTime = requestEnd - requestStart;
                        <span class="hljs-keyword">return</span> requestTime;
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// Valeurs pour les opérations de type "RUN" ou autres</span>
                    }
                }),
                <span class="hljs-attr">pointRadius</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// Diamètre des points sur le graphique</span>
            }
        ]
    }
};

msg.payload = chartData; <span class="hljs-comment">// Attribuez les données du graphique au message</span>
<span class="hljs-keyword">return</span> msg; <span class="hljs-comment">// Renvoyez le message</span>
</div></code></pre>
<h3 id="1562-pdf">15.6.2. PDF</h3>
<p>Une fois les chart créer,  je les réutilise dans le noeud de création de PDF pour les ajouter au rapport :</p>
<pre class="hljs"><code><div><span class="hljs-comment">/**
 * 
 * Vu precedemment
 * 
 */</span>
{
            <span class="hljs-attr">text</span>: <span class="hljs-string">"Gatling"</span>, <span class="hljs-comment">// Section Gatling</span>
            <span class="hljs-attr">style</span>: <span class="hljs-string">"header2"</span>
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"Nom de la simulation :                 "</span> + msg.payload.gatling.Assertion.simulation <span class="hljs-comment">// Nom de la simulation Gatling</span>
        },
        {
            <span class="hljs-attr">text</span>: <span class="hljs-string">"Commencée :                 "</span> + msg.payload.gatling.Assertion.start <span class="hljs-comment">// Date de début de la simulation Gatling (à formater)</span>
        },
        {
            <span class="hljs-attr">image</span>: <span class="hljs-string">'gatlingImage'</span>, <span class="hljs-comment">// Image Gatling</span>
            <span class="hljs-attr">width</span>: <span class="hljs-number">500</span>,
        },
        {
            <span class="hljs-attr">image</span>: <span class="hljs-string">'gatlingGraphComplete'</span>, <span class="hljs-comment">// Image graphique complet Gatling</span>
            <span class="hljs-attr">width</span>: <span class="hljs-number">500</span>,
        },
    ],
    <span class="hljs-attr">images</span>: {
        <span class="hljs-attr">voltImage</span>: <span class="hljs-string">'data:image/png;base64,'</span> + msg.payload.voltGraph.toString(<span class="hljs-string">'base64'</span>), <span class="hljs-comment">// Utilisation du buffer pour l'image Volt</span>
        <span class="hljs-attr">wattImage</span>: <span class="hljs-string">'data:image/png;base64,'</span> + msg.payload.wattGraph.toString(<span class="hljs-string">'base64'</span>),  <span class="hljs-comment">// Utilisation du buffer pour l'image Watt de Volt</span>
        <span class="hljs-attr">nidusImage</span>: <span class="hljs-string">'data:image/png;base64,'</span> + msg.payload.nidusGraph.toString(<span class="hljs-string">'base64'</span>),  <span class="hljs-comment">// Utilisation du buffer pour l'image Nidus</span>
        <span class="hljs-attr">gatlingImage</span>: <span class="hljs-string">'data:image/png;base64,'</span> + msg.payload.gatlingGraph.toString(<span class="hljs-string">'base64'</span>),  <span class="hljs-comment">// Utilisation du buffer pour l'image Gatling</span>
        <span class="hljs-attr">gatlingGraphComplete</span>: <span class="hljs-string">'data:image/png;base64,'</span> + msg.payload.gatlingGraphComplete.toString(<span class="hljs-string">'base64'</span>),  <span class="hljs-comment">// Utilisation du buffer pour l'image Gatling</span>
    },
<span class="hljs-comment">/**
 * 
 * Vu precedemment
 * 
 */</span>
</div></code></pre>
<h2 id="157-refactoring">15.7. Refactoring</h2>
<p>Pour finir, j'ai créer des subflow pour le noeud MQTT afin de simplifier la visualisation et le management des données :<br>
<img src="../capture/RPI/Node-Red/RapportPDF/9.png" alt="Alt text" width="100%" style="width:100%;"><br>
<img src="../capture/RPI/Node-Red/RapportPDF/10.png" alt="Alt text" width="100%" style="width:100%;"></p>
<h1 id="gatling-v30">Gatling V3.0</h1>
<p>Maintenant que l'état de &quot;PoC&quot; à été atteint, il est temps de passer à la version utilisable du projet, maintenant  il est possible depuis Node-Red de  :</p>
<ul>
<li>Lancer des StressTest</li>
<li>Lancer des test Gatling</li>
<li>Récupèrer les information de monittoring(CPU, RAM, Température, etc...)</li>
<li>Récupèrer les information de Gatling (Temps de réponse, pourcentage de réussite, etc...)</li>
<li>Joindre les information pour créer des graphiques</li>
<li>Joindre tout pour créer un rapport PDF</li>
</ul>
<p>Le but à atteindre donc seraient de pouvoir :</p>
<ul>
<li>Passer des paramètres de test à Gatling depuis Node-Red</li>
<li>Passer le CSV de Gatling avec Node-Red</li>
<li>Améliorer l'UI de Node-Red</li>
<li>Ajouter les valeurs souhaitées dans le rapport PDF</li>
<li>Modifier les graphique pour en améliorer la lisibilité</li>
<li>Ajouter la possibilitée d'exporter les donnée en JSON</li>
<li>Ajouter la possibilitée d'importer les donnée en JSON et d'en generer un PDF</li>
</ul>
<h2 id="ui">UI</h2>
<p>Pour l'interface utilisateur (UI), j'ai choisi de limiter le temps sélectionné à la durée du test. Ce choix s'explique par le fait qu'en principe, la durée des mesures devrait toujours correspondre à la durée de Gatling. Cependant, je laisse toujours la possibilité de définir la durée du StressTest indépendamment de Gatling.</p>
<p>J'ai ajouté une entrée pour définir si un ventilateur est activé. Actuellement, avec des températures proches de 30 degrés à l'extérieur, le ventilateur est nécessaire pour éviter la surchauffe du Raspberry Pi. Sachant cela, je voulais avoir la possibilité de le notifier dans le rapport.</p>
<p>À l'heure actuelle, le ventilateur est un ventilateur de bureau pris dans mon stock personnel, actionné par un bouton. Il n'est donc pas possible de le contrôler depuis Node-Red. Cependant, il est possible qu'à l'avenir, un ventilateur contrôlable soit utilisé, auquel cas il sera possible de l'activer ou de le désactiver depuis Node-Red.</p>
<p>Pour permettre de garder un certain contrôle, j'ai ajouté les informations de monitoring directement à côté du formulaire de lancement du test. Ainsi, il est possible de voir les valeurs de monitoring en temps réel et de surveiller le déroulement du test.</p>
<h3 id="ventilateur">Ventilateur</h3>
<img src="../capture/RPI/Node-Red/RapportPDF/ventilateur-vintage-indola-5-scaled.jpg" alt="Alt text" width="100%" style="width:100%;">
<h3 id="ui">UI</h3>
<img src="../capture/RPI/Node-Red/RapportPDF/11.png" alt="Alt text" width="100%" style="width:100%;">
<h1 id="16-remerciement">16. Remerciement</h1>
<p>Je tiens à exprimer ma profonde gratitude envers les personnes qui ont joué des rôles essentiels dans la réalisation de ce projet. Avant tout, je souhaite exprimer ma sincère reconnaissance à M. Benoit Vianin, dont la proposition du projet, le matériel fourni et les conseils avisés ont été cruciaux pour sa mise en place. Sa précieuse assistance technique a été d'une grande importance.</p>
<p>Je tiens également à adresser mes remerciements à M. Fabien Maire, Directeur du service Informatique du SIS2 (Service Informatique du Secondaire 2), pour son accompagnement et ses conseils tout au long de ce travail. Sa vision éclairée et son expertise ont été des facteurs clés dans la réussite de ce projet.</p>
<p>Un remerciement spécial s'adresse à M. Christophe Singele, enseignant en microtechnique au CPNE-TI, pour son soutien inestimable dans la compréhension des schémas électriques et dans la résolution des problèmes de câblage et de connectique. Sa patience et ses connaissances ont été une source inestimable d'aide.</p>
<p>Je saisis également cette occasion pour exprimer ma gratitude envers l'équipe du SIS2 pour son accueil chaleureux dans leurs locaux et pour le soutien constant qu'ils m'ont apporté tout au long de ce travail. Leur environnement de travail a été propice à la réalisation de ce projet.</p>
<p>Je remercie sincèrement M. Patrice Lüthi, enseignant en informatique au CPNE-TI, pour sa contribution essentielle dans la mise en place de la communication entre l'INA219 et les Raspberry Pi. Son expertise technique a joué un rôle clé dans la résolution des défis techniques.</p>
<p>Enfin, Un remerciement tout particulier à ma mère et à ma copine pour leur soutien infaillible durant ma formation, qui m'a conduit à accomplir ce travail. Leur encouragement constant et leur confiance en moi ont été des sources d'inspiration essentielles.</p>
<p>Ces individus exceptionnels ont joué un rôle capital dans la réalisation de ce projet. Leur soutien, leur expertise et leur encouragement ont été essentiels, et je leur suis profondément reconnaissant.</p>
<div style="page-break-after: always;"></div>
<h1 id="17-sources">17. Sources</h1>
<ol>
<li>
<p><strong>Guide d'Installation Node-Red</strong><br>
<a href="https://nodered.org/docs/getting-started/raspberrypi">Installer Node-Red</a></p>
</li>
<li>
<p><strong>Guide de Sécurisation de Node-Red</strong><br>
<a href="https://nodered.org/docs/user-guide/runtime/securing-node-red">Sécurisation de Node-Red</a></p>
</li>
<li>
<p><strong>Tutoriel de Base Rototron</strong><br>
<a href="https://www.rototron.info/raspberry-pi-ina219-tutorial/">Tutoriel Rototron</a></p>
</li>
<li>
<p><strong>Documentation Technique de l'INA219</strong><br>
<a href="https://www.ti.com/lit/ds/symlink/ina219.pdf">Documentation INA219</a></p>
</li>
<li>
<p><strong>Recherche de M. Lamber</strong><br>
<a href="https://www.researchgate.net/publication/350387196_Power_Consumption_Profiling_of_a_Lightweight_Development_Board_Sensing_with_the_INA219_and_Teensy_40_Microcontroller">Profil de Consommation par M. Lamber</a></p>
</li>
<li>
<p><strong>Recherche de M. Pol J. Planas Pulido</strong><br>
<a href="https://upcommons.upc.edu/bitstream/handle/2117/180533/tfg-report-pol-planas.pdf?sequence=1&amp;isAllowed=y">Profil de Consommation par M. Pol J. Planas Pulido</a></p>
</li>
<li>
<p><strong>Bibliothèque Python pour l'INA219</strong><br>
<a href="https://pypi.org/project/pi-ina219/">Bibliothèque pi-ina219</a></p>
</li>
<li>
<p><strong>Forum Problème de Détection I2C</strong><br>
<a href="https://forums.raspberrypi.com/viewtopic.php?t=272351#p1652031">Forum Raspberry Pi</a></p>
</li>
<li>
<p><strong>Tutoriel Mise en Place INA219</strong><br>
<a href="https://binaryfury.wann.net/2014/04/solarbatteryload-power-logging-with-raspberry-pi-and-ina219/">Tutoriel INA219</a></p>
</li>
<li>
<p><strong>Tutoriel Création d'un Enregistreur de Consommation</strong><br>
<a href="https://www.hackster.io/Sparky/diy-power-logger-using-i2c-python-9a39e0">Tutoriel Enregistreur de Consommation</a></p>
</li>
<li>
<p><strong>Tutoriel Complet avec Arduino</strong><br>
<a href="https://electropeak.com/learn/interfacing-ina219-current-sensor-module-with-arduino/">Tutoriel Complet avec Arduino</a></p>
</li>
<li>
<p><strong>Téléchargement Gatling</strong><br>
<a href="https://repo1.maven.org/maven2/io/gatling/highcharts/gatling-charts-highcharts-bundle/3.9.5/gatling-charts-highcharts-bundle-3.9.5-bundle.zip">Téléchargement Gatling</a></p>
</li>
<li>
<p><strong>Tutoriel Avancé Gatling</strong><br>
<a href="https://gatling.io/docs/gatling/tutorials/advanced/">Tutoriel Avancé Gatling</a></p>
</li>
<li>
<p><strong>Tutoriel de Démarrage Rapide Gatling</strong><br>
<a href="https://gatling.io/docs/gatling/tutorials/quickstart/">Tutoriel de Démarrage Rapide Gatling</a></p>
</li>
<li>
<p><strong>Tutoriel sur l'utilisation de S1seven</strong><br>
<a href="https://www.s1seven.com/blog/use-s1sevens-certificate-tools-to-convert-a-json-certificate-to-a-pdf/">Tutoriel S1seven</a></p>
</li>
</ol>

</body>
</html>
